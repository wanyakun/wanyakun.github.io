<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NSNotification | 坤坤同学</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="关心你所关心的，与世界分享你的知识、经验和见闻">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.91675566.css" as="style"><link rel="preload" href="/assets/js/app.86aa6019.js" as="script"><link rel="preload" href="/assets/js/4.10069921.js" as="script"><link rel="preload" href="/assets/js/1.c288e991.js" as="script"><link rel="preload" href="/assets/js/76.d5eecf1b.js" as="script"><link rel="preload" href="/assets/js/9.1417a78f.js" as="script"><link rel="prefetch" href="/assets/js/10.3ed9434f.js"><link rel="prefetch" href="/assets/js/100.fa901c4d.js"><link rel="prefetch" href="/assets/js/101.cdd053cd.js"><link rel="prefetch" href="/assets/js/102.0251f401.js"><link rel="prefetch" href="/assets/js/11.a6693458.js"><link rel="prefetch" href="/assets/js/12.2e880116.js"><link rel="prefetch" href="/assets/js/13.80335f39.js"><link rel="prefetch" href="/assets/js/14.ffd894ca.js"><link rel="prefetch" href="/assets/js/15.89531ed0.js"><link rel="prefetch" href="/assets/js/16.e7942625.js"><link rel="prefetch" href="/assets/js/17.6f30b859.js"><link rel="prefetch" href="/assets/js/18.eb9c8310.js"><link rel="prefetch" href="/assets/js/19.e9353a96.js"><link rel="prefetch" href="/assets/js/20.20996294.js"><link rel="prefetch" href="/assets/js/21.a28ca72c.js"><link rel="prefetch" href="/assets/js/22.6ef7b6a2.js"><link rel="prefetch" href="/assets/js/23.c0313df7.js"><link rel="prefetch" href="/assets/js/24.773abc82.js"><link rel="prefetch" href="/assets/js/25.b4e9e073.js"><link rel="prefetch" href="/assets/js/26.fed5348c.js"><link rel="prefetch" href="/assets/js/27.35ccc14b.js"><link rel="prefetch" href="/assets/js/28.5b59b539.js"><link rel="prefetch" href="/assets/js/29.033a2429.js"><link rel="prefetch" href="/assets/js/30.8c56543c.js"><link rel="prefetch" href="/assets/js/31.0a8a1d80.js"><link rel="prefetch" href="/assets/js/32.9784b164.js"><link rel="prefetch" href="/assets/js/33.9c36cd77.js"><link rel="prefetch" href="/assets/js/34.55a29e37.js"><link rel="prefetch" href="/assets/js/35.a00d6970.js"><link rel="prefetch" href="/assets/js/36.f7f96931.js"><link rel="prefetch" href="/assets/js/37.1c140229.js"><link rel="prefetch" href="/assets/js/38.e19d1e55.js"><link rel="prefetch" href="/assets/js/39.85ea9a14.js"><link rel="prefetch" href="/assets/js/40.410f9a63.js"><link rel="prefetch" href="/assets/js/41.a2193986.js"><link rel="prefetch" href="/assets/js/42.212bc6a4.js"><link rel="prefetch" href="/assets/js/43.9d4ec479.js"><link rel="prefetch" href="/assets/js/44.bbe4e5de.js"><link rel="prefetch" href="/assets/js/45.5e8dca7b.js"><link rel="prefetch" href="/assets/js/46.0d726ab7.js"><link rel="prefetch" href="/assets/js/47.399e34db.js"><link rel="prefetch" href="/assets/js/48.a3036e65.js"><link rel="prefetch" href="/assets/js/49.899c50a1.js"><link rel="prefetch" href="/assets/js/5.da3929a7.js"><link rel="prefetch" href="/assets/js/50.2a6aef37.js"><link rel="prefetch" href="/assets/js/51.77de6b86.js"><link rel="prefetch" href="/assets/js/52.34430815.js"><link rel="prefetch" href="/assets/js/53.e298b416.js"><link rel="prefetch" href="/assets/js/54.a0638887.js"><link rel="prefetch" href="/assets/js/55.21517304.js"><link rel="prefetch" href="/assets/js/56.8f2ebec8.js"><link rel="prefetch" href="/assets/js/57.cab99a32.js"><link rel="prefetch" href="/assets/js/58.63d246a9.js"><link rel="prefetch" href="/assets/js/59.4277086c.js"><link rel="prefetch" href="/assets/js/6.e39f5ca0.js"><link rel="prefetch" href="/assets/js/60.bc333cb8.js"><link rel="prefetch" href="/assets/js/61.5a424c7f.js"><link rel="prefetch" href="/assets/js/62.7adc686f.js"><link rel="prefetch" href="/assets/js/63.c50face7.js"><link rel="prefetch" href="/assets/js/64.3ab22c7d.js"><link rel="prefetch" href="/assets/js/65.49a77af0.js"><link rel="prefetch" href="/assets/js/66.f74b86c1.js"><link rel="prefetch" href="/assets/js/67.a7794b45.js"><link rel="prefetch" href="/assets/js/68.2023979f.js"><link rel="prefetch" href="/assets/js/69.8c7721ee.js"><link rel="prefetch" href="/assets/js/7.694cc372.js"><link rel="prefetch" href="/assets/js/70.c837a105.js"><link rel="prefetch" href="/assets/js/71.593a8163.js"><link rel="prefetch" href="/assets/js/72.c145565e.js"><link rel="prefetch" href="/assets/js/73.6c284ed8.js"><link rel="prefetch" href="/assets/js/74.713d03f3.js"><link rel="prefetch" href="/assets/js/75.3091dd08.js"><link rel="prefetch" href="/assets/js/77.68b537f6.js"><link rel="prefetch" href="/assets/js/78.7f26a50c.js"><link rel="prefetch" href="/assets/js/79.4cab3279.js"><link rel="prefetch" href="/assets/js/8.762d7cfc.js"><link rel="prefetch" href="/assets/js/80.764c4018.js"><link rel="prefetch" href="/assets/js/81.cfdf726f.js"><link rel="prefetch" href="/assets/js/82.89fe1b6b.js"><link rel="prefetch" href="/assets/js/83.9b7cde73.js"><link rel="prefetch" href="/assets/js/84.cb9f1c8c.js"><link rel="prefetch" href="/assets/js/85.9f01ab26.js"><link rel="prefetch" href="/assets/js/86.89bcd1da.js"><link rel="prefetch" href="/assets/js/87.cb854294.js"><link rel="prefetch" href="/assets/js/88.c93205c6.js"><link rel="prefetch" href="/assets/js/89.710cd1f3.js"><link rel="prefetch" href="/assets/js/90.6271fd01.js"><link rel="prefetch" href="/assets/js/91.2ebfb8a1.js"><link rel="prefetch" href="/assets/js/92.b736829a.js"><link rel="prefetch" href="/assets/js/93.f3de7541.js"><link rel="prefetch" href="/assets/js/94.11400c8d.js"><link rel="prefetch" href="/assets/js/95.c5edf39a.js"><link rel="prefetch" href="/assets/js/96.c92647a6.js"><link rel="prefetch" href="/assets/js/97.599e7f06.js"><link rel="prefetch" href="/assets/js/98.826272d9.js"><link rel="prefetch" href="/assets/js/99.67d131b1.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.254f7798.js">
    <link rel="stylesheet" href="/assets/css/0.styles.91675566.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>坤坤同学</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>关心你所关心的，与世界分享你的知识、经验和见闻</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="坤坤同学" class="logo"> <span class="site-name">坤坤同学</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    wanyakun
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>36</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>3</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/ios/" aria-current="page" class="sidebar-link">关于</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目经验</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三方库原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>提问</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>NSNotification</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">NSNotification</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>wanyakun</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>5/21/2021</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><p>通知是同步的, 发送通知的流程：总的来说，就是根据Notification Name查找对应的Observer链表，然后遍历整个链表，给每个Observer节点中保持的对象及SEL发送消息，也就是调用对象的SEL方法<br>
首先会定一个数组ObserverArray来保存需要通知的Observer。先遍历wildcard链表，将其中所有的Observer加入到数组中（因为wildcard链表中的observe接收所有的通知）<br>
找到以object为key的Observer链表。这个过程分为在Named Table和UnNamed Table中查找，然后将遍历查找到的链表，同样加入到数组中。<br>
遍历数组，依次取出节点发送Notification</p> <h2 id="主要类"><a href="#主要类" class="header-anchor">#</a> 主要类</h2> <h3 id="notification"><a href="#notification" class="header-anchor">#</a> Notification</h3> <p>对通知的本身信息进行封装，比如通知的name，发送对象，额外信息等。<br>
一般直接使用NotificationCenter调用<code>[[NSNotificationCenter defaultCenter] postNotificationName:@&quot;xxx&quot; object:nil userInfo:nil]</code>, 方法内部直接创建Notification对象并发出通知。</p> <h3 id="notificationcenter"><a href="#notificationcenter" class="header-anchor">#</a> NotificationCenter</h3> <p>对整个通知的流程进行管理，比如添加观察者，发送通知，移除观察者。<br> <strong>添加观察者：</strong> <code>addObserver:selector:name:object:</code><br> <code>addObserverForName:object:queue:usingBlock:</code><br> <strong>移除观察者：</strong><br> <code>removeObserver:</code><br> <code>removeObserver:name:object:</code><br> <strong>发出通知：</strong><br> <code>postNotification:</code><br> <code>postNotificationName:object:</code><br> <code>postNotificationName:object:userInfo:</code></p> <h3 id="nsnotificationqueue"><a href="#nsnotificationqueue" class="header-anchor">#</a> NSNotificationQueue</h3> <p>提供更加灵活的设置，比如设置通知的合并策略，发送时机。<br>
在NSNotificationCenter中起到一个缓冲作用。放入队列中的通知可能会延迟，直到当前的runloop结束或者runloop处于空闲状态才发送，具体的要根据设置的策略而定。<br> <strong>NSPostingStyle：</strong> 用于配置发送时机</p> <ul><li>NSPostASAP：在当前通知调用或者计时器结束时发出通知</li> <li>NSPostWhileIdle：当runloop处于空闲时发出通知</li> <li>NSPostNow：在合并通知完成后立即发出通知</li></ul> <p><strong>NSNotificationCoalescing：</strong> 这是一个NS_OPTION，用于配置如何合并通知</p> <ul><li>NSNotificationNoCoalescing：不合并通知</li> <li>NSNotificationCoalescingOnName：按通知名字合并</li> <li>NSNotificationCoalescingOnSender：按传人的object合并通知</li></ul> <h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <h3 id="数据结构关系"><a href="#数据结构关系" class="header-anchor">#</a> 数据结构关系</h3> <p>NSNotificationCenter定义了两个Table（nameless和named），同时为了封装观察者信息，也定义了Observation保存观察者信息。他们的结构体可以简化如下所示：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 根容器，NSNotificationCenter持有</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> NCTbl <span class="token punctuation">{</span>
  Observation		<span class="token operator">*</span>wildcard<span class="token punctuation">;</span>	<span class="token comment">/* 链表结构，保存既没有name也没有object的通知 */</span>
  GSIMapTable		nameless<span class="token punctuation">;</span>	<span class="token comment">/* 存储没有name但是有object的通知	*/</span>
  GSIMapTable		named<span class="token punctuation">;</span>		<span class="token comment">/* 存储带有name的通知，不管有没有object	*/</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> NCTable<span class="token punctuation">;</span>

<span class="token comment">// Observation（链表） 存储观察者和响应结构体，基本的存储单元</span>
<span class="token keyword">typedef</span>	<span class="token keyword">struct</span>	Obs <span class="token punctuation">{</span>
  id		observer<span class="token punctuation">;</span>	<span class="token comment">/* 观察者，接收通知的对象	*/</span>
  SEL		selector<span class="token punctuation">;</span>	<span class="token comment">/* 响应方法		*/</span>
  <span class="token keyword">struct</span> Obs	<span class="token operator">*</span>next<span class="token punctuation">;</span>		<span class="token comment">/* Next item in linked list.	*/</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> Observation<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>其中GSIMap的结构如下：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _GSIMapBucket GSIMapBucket_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> _GSIMapNode GSIMapNode_t<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> GSIMapBucket_t <span class="token operator">*</span>GSIMapBucket<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> GSIMapNode_t <span class="token operator">*</span>GSIMapNode<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> _GSIMapTable GSIMapTable_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> GSIMapTable_t <span class="token operator">*</span>GSIMapTable<span class="token punctuation">;</span>

<span class="token keyword">struct</span>	_GSIMapNode <span class="token punctuation">{</span>
    GSIMapNode	nextInBucket<span class="token punctuation">;</span>	<span class="token comment">/* Linked list of bucket.	*/</span>
    GSIMapKey	key<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span>	<span class="token expression">GSI_MAP_HAS_VALUE</span></span>
    GSIMapVal	value<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span>	_GSIMapBucket <span class="token punctuation">{</span>
    uintptr_t	nodeCount<span class="token punctuation">;</span>	<span class="token comment">/* Number of nodes in bucket.	*/</span>
    GSIMapNode	firstNode<span class="token punctuation">;</span>	<span class="token comment">/* The linked list of nodes.	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span>	_GSIMapTable <span class="token punctuation">{</span>
  NSZone	<span class="token operator">*</span>zone<span class="token punctuation">;</span>
  uintptr_t	nodeCount<span class="token punctuation">;</span>	<span class="token comment">/* Number of used nodes in map.	*/</span>
  uintptr_t	bucketCount<span class="token punctuation">;</span>	<span class="token comment">/* Number of buckets in map.	*/</span>
  GSIMapBucket	buckets<span class="token punctuation">;</span>	<span class="token comment">/* Array of buckets.		*/</span>
  GSIMapNode	freeNodes<span class="token punctuation">;</span>	<span class="token comment">/* List of unused nodes.	*/</span>
  uintptr_t	chunkCount<span class="token punctuation">;</span>	<span class="token comment">/* Number of chunks in array.	*/</span>
  GSIMapNode	<span class="token operator">*</span>nodeChunks<span class="token punctuation">;</span>	<span class="token comment">/* Chunks of allocated memory.	*/</span>
  uintptr_t	increment<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>	<span class="token expression">GSI_MAP_EXTRA</span></span>
  GSI_MAP_EXTRA	extra<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>GSIMapTable映射表包含了指向GSIMapNode单链表节点的指针数组nodeChunks，通过buckets数组记录单链表节点指针数组的各个链表的节点数量及链表首部地址，其中bucketCount、nodeCount及chunkCount分别记录了node节点、节点单链表信息数组、节点单链表指针数组的数目；<br>
其实就是一个hash表结构，既可以以数组的形式取到每个单链表首元素，也可以以链表的形式获取，通过数组能够方便取到每个单向链表，再利用链表结构增删。</p> <p>在NSNotificationCenter内部一共保存了两张表，一张用于保存添加观察者的时候传入的NotificationName的情况；一张用于保存添加观察者的时候没有传入NotificationName的情况</p> <h3 id="named-table"><a href="#named-table" class="header-anchor">#</a> Named Table</h3> <p>结构为两层Table嵌套，外层以通知名称为Key，其value同样是一个Table，内层Table以Object为key，用链表保存所有的观察者，并且以这个链表为value</p> <ul><li>key(name)</li> <li>value(mapTable)
<ul><li>key(object)</li> <li>value(Observation对象)</li></ul></li></ul> <p><img src="/assets/img/ios/basic/named-table.jpg" alt="Named Table"></p> <h3 id="unnamed-table"><a href="#unnamed-table" class="header-anchor">#</a> UnNamed Table</h3> <p>相对于Named Table，少了一层外层Table</p> <p><img src="/assets/img/ios/basic/unnamed-table.jpg" alt="UnNamed Table"></p> <p>如果在注册观察者时没有传入NotificationName，同时没有传入object，所有的系统通知都会发送到注册的对象里, 即wildcard链表中所有的对象。</p> <h3 id="添加观察者流程"><a href="#添加观察者流程" class="header-anchor">#</a> 添加观察者流程</h3> <p>添加观察者一般调用方法<code>[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(onEventNotification:) name:NotificationName object:nil];</code>来实现，大致流程如下：</p> <p><img src="/assets/img/ios/basic/notification-add.png" alt="Notifcation add"></p> <h3 id="发送通知流程"><a href="#发送通知流程" class="header-anchor">#</a> 发送通知流程</h3> <p>发送通知一般是调用方法<code>postNotificationName:object:userInfo:</code>，该方法会实例化一个NSNotification对象来保存传入的参数，包括：name，Object和userInfo。总的来说，就是根据Notification Name查找对应的Observer链表，然后遍历整个链表，给每个Observer节点中保持的对象及SEL发送消息，也就是调用对象的SEL方法，大致流程如下：</p> <p><img src="/assets/img/ios/basic/notification-post.png" alt="Notifcation add"></p> <p>从发送过程来看，发送通知和接收通知是在同一个线程中同步执行的。</p> <h2 id="通知与多线程"><a href="#通知与多线程" class="header-anchor">#</a> 通知与多线程</h2> <p>从通知发送流程来看，我们知道通知的发送和接收是同步执行的，即当在主线程中发出通知时，然后接收方在主线程处理逻辑，处理完成后，发送方才能继续执行剩下的逻辑。<br>
那Notification和线程同步有什么关系呢？</p> <blockquote><p>In a multithreaded application, notifications are always delivered in the thread in which the notification was posted, which may not be the same thread in which an observer registered itself.</p> <p>在多线程应用程序中，通知总是在发出通知的线程中传递，而该线程不一定是观察者观察者的那个线程。</p> <p>For example, if an object running in a background thread is listening for notifications from the user interface, such as a window closing, you would like to receive the notifications in the background thread instead of the main thread. In these cases, you must capture the notifications as they are delivered on the default thread and redirect them to the appropriate thread.</p> <p>例如，如果在后台线程中运行的对象正在监听来自用户界面的通知，例如窗口关闭，则希望在后台线程而不是主线程中接收通知。在这些情况下，您必须在默认线程上传递通知时捕获它们，并将它们重定向到适当的线程中。</p></blockquote> <p>常见的面试问题是：<strong>如何保证通知接收的线程在主线程？</strong></p> <ol><li>使用addObserverForName: object: queue: usingBlock方法注册通知，指定在mainqueue上响应block</li> <li>在主线程注册一个machPort，它是用来做线程通信的，设置这个port的delegate，通过这个Port其他线程可以跟主线程通信，在这个port的代理回调中执行的代码肯定在主线程中运行，所以当在异步线程收到通知，然后给machPort发送消息即可</li></ol> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">//</span>
<span class="token comment">//  YKNoteNotificationViewController.m</span>
<span class="token comment">//  YKNote</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by wanyakun on 2021/5/26.</span>
<span class="token comment">//  Copyright © 2021 wanyakun.github.io. All rights reserved.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">&quot;YKNoteNotificationViewController.h&quot;</span></span>

<span class="token keyword">@interface</span> <span class="token function">YKNoteNotificationViewController</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>NSMachPortDelegate<span class="token operator">&gt;</span>

<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSMutableArray     <span class="token operator">*</span>notifications<span class="token punctuation">;</span>         <span class="token comment">// 通知队列</span>
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSThread           <span class="token operator">*</span>notificationThread<span class="token punctuation">;</span>    <span class="token comment">// 期望线程</span>
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSLock             <span class="token operator">*</span>notificationLock<span class="token punctuation">;</span>      <span class="token comment">// 用于对通知队列加锁的锁对象，避免线程冲突</span>
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSMachPort         <span class="token operator">*</span>notificationPort<span class="token punctuation">;</span>      <span class="token comment">// 用于向期望线程发送信号的通信端口</span>

<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> YKNoteNotificationViewController

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Do any additional setup after loading the view.</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">@&quot;Notification&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;current thread = %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">self</span><span class="token punctuation">.</span>notifications <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSMutableArray alloc<span class="token punctuation">]</span> initWithCapacity<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSLock alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>notificationThread <span class="token operator">=</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>notificationPort <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSMachPort alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>notificationPort<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span> addPort<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationPort forMode<span class="token punctuation">:</span>NSRunLoopCommonModes<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>NSNotificationCenter defaultCenter<span class="token punctuation">]</span> addObserver<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>processNotification<span class="token punctuation">:</span><span class="token punctuation">)</span> name<span class="token punctuation">:</span><span class="token string">@&quot;KNotificationTest&quot;</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>NSNotificationCenter defaultCenter<span class="token punctuation">]</span> postNotificationName<span class="token punctuation">:</span><span class="token string">@&quot;KNotificationTest&quot;</span> object<span class="token punctuation">:</span>nil userInfo<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>processNotification<span class="token punctuation">:</span><span class="token punctuation">(</span>NSNotification <span class="token operator">*</span><span class="token punctuation">)</span>notifcation <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>notificationThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 转发到正确的线程</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock lock<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notifications addObject<span class="token punctuation">:</span>notifcation<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock unlock<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationPort sendBeforeDate<span class="token punctuation">:</span><span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span> components<span class="token punctuation">:</span>nil from<span class="token punctuation">:</span>nil reserved<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在这里处理通知</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;current thread = %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;process notifcation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> NSMachPortDelegate</span></span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>handleMachMessage<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>msg <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock lock<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>notifications<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NSNotification <span class="token operator">*</span>notification <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notifications objectAtIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notifications removeObjectAtIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock unlock<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span> processNotification<span class="token punctuation">:</span>notification<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock lock<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>notificationLock unlock<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <ol><li>通知的发送是同步的，还是异步的？<br>
同步发送</li> <li>NSNotifactionCenter接收消息和发送消息是在同一个线程里吗？如何异步发送消息？<br>
是的，是在同一个线程中，异步线程发送通知则响应函数也是在异步线程。<br>
异步发送通知可以开启异步线程发送即可。</li> <li>NSNotifacionQueue是异步还是同步发送？在哪个线程响应？<br>
通知队列，用于异步发送消息，这个异步并不是开启线程，而是把通知存到双向链表实现的队列里面，等待某个时机触发时调用NSNotificationCenter的发送接口进行发送通知，这么看NSNotificationQueue 最终还是调用NSNotificationCenter进行消息的分发<br>
依赖runloop，所以如果在其他子线程使用NSNotificationQueue，需要开启runloop，最终还是通过NSNotificationCenter进行发送通知，所以这个角度讲它还是同步的，所谓异步，指的是非实时发送而是在合适的时机发送（延时发送），并没有开启异步线程</li> <li>NSNotifacionQueue和Runloop的关系？<br>
NSNotificationQueue依赖runloop. 因为通知队列要在runloop回调的某个时机调用通知中心发送通知，NSNotificationQueue主要做了两件事：</li></ol> <ul><li>添加通知到队列</li> <li>删除通知</li></ul> <ol start="5"><li>如何保证通知接收的线程在主线程？<br>
参考<a href="#%E9%80%9A%E7%9F%A5%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B">通知与多线程</a></li> <li>页面销毁时不移除通知会崩溃吗？<br>
iOS9.0之前，会crash，原因：通知中心对观察者的引用是unsafe_unretained，导致当观察者释放的时候，观察者的指针值并不为nil，出现野指针.<br>
iOS9.0之后，不会crash，原因：通知中心对观察者的引用是weak。<br>
当 iOS 9.0+ 时，不移除通知不会崩溃；当低于 iOS 9.0 时，需要手动移除通知。<br>
使用 addObserverForName:object:queue:usingBlock:  添加的通知，即使不移除，也不会崩溃，但是造成内存泄漏。</li> <li>多次添加同一个通知会是什么结果？多次移除通知呢？<br>
多次添加同一个通知，会导致发送一次这个通知，响应多次通知回调<br>
多次移除通知不会产生crash</li> <li>下面的方式能接收到通知吗？为什么？</li></ol> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 发送通知  </span>
<span class="token punctuation">[</span><span class="token punctuation">[</span>NSNotificationCenter defaultCenter<span class="token punctuation">]</span> addObserver<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>handleNotification<span class="token punctuation">:</span><span class="token punctuation">)</span> name<span class="token punctuation">:</span><span class="token string">@&quot;TestNotification&quot;</span> object<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 接收通知  </span>
<span class="token punctuation">[</span>NSNotificationCenter<span class="token punctuation">.</span>defaultCenter postNotificationName<span class="token punctuation">:</span><span class="token string">@&quot;TestNotification&quot;</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>存储是以name和object为维度的，即判定是不是同一个通知要从name和object区分，如果他们都相同则认为是同一个通知，后面包括查找逻辑、删除逻辑都是以这两个为维度的<br>
故而不会。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/23/2022, 5:52:31 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/ios/basic/oc/kvc.html" class="prev">
            KVC
          </a></span> <span class="next"><a href="/ios/basic/oc/category-extension.html">
            Category和Extension
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/ios/basic/oc/notification.html#主要类" class="sidebar-link reco-side-主要类" data-v-70334359>主要类</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#notification" class="sidebar-link reco-side-notification" data-v-70334359>Notification</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#notificationcenter" class="sidebar-link reco-side-notificationcenter" data-v-70334359>NotificationCenter</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#nsnotificationqueue" class="sidebar-link reco-side-nsnotificationqueue" data-v-70334359>NSNotificationQueue</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/oc/notification.html#实现原理" class="sidebar-link reco-side-实现原理" data-v-70334359>实现原理</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#数据结构关系" class="sidebar-link reco-side-数据结构关系" data-v-70334359>数据结构关系</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#named-table" class="sidebar-link reco-side-named-table" data-v-70334359>Named Table</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#unnamed-table" class="sidebar-link reco-side-unnamed-table" data-v-70334359>UnNamed Table</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#添加观察者流程" class="sidebar-link reco-side-添加观察者流程" data-v-70334359>添加观察者流程</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/notification.html#发送通知流程" class="sidebar-link reco-side-发送通知流程" data-v-70334359>发送通知流程</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/oc/notification.html#通知与多线程" class="sidebar-link reco-side-通知与多线程" data-v-70334359>通知与多线程</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/oc/notification.html#常见问题" class="sidebar-link reco-side-常见问题" data-v-70334359>常见问题</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.86aa6019.js" defer></script><script src="/assets/js/4.10069921.js" defer></script><script src="/assets/js/1.c288e991.js" defer></script><script src="/assets/js/76.d5eecf1b.js" defer></script><script src="/assets/js/9.1417a78f.js" defer></script>
  </body>
</html>
