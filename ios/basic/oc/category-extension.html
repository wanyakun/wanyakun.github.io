<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Category和Extension | 坤坤同学</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="关心你所关心的，与世界分享你的知识、经验和见闻">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.b020364b.css" as="style"><link rel="preload" href="/assets/js/app.089bdbaa.js" as="script"><link rel="preload" href="/assets/js/4.8c49e3da.js" as="script"><link rel="preload" href="/assets/js/1.020c262d.js" as="script"><link rel="preload" href="/assets/js/86.4e70842d.js" as="script"><link rel="preload" href="/assets/js/14.89e438f3.js" as="script"><link rel="prefetch" href="/assets/js/10.3956505e.js"><link rel="prefetch" href="/assets/js/100.9dafe4d7.js"><link rel="prefetch" href="/assets/js/101.6c4f908c.js"><link rel="prefetch" href="/assets/js/102.ffa22b0e.js"><link rel="prefetch" href="/assets/js/103.f7900f0f.js"><link rel="prefetch" href="/assets/js/104.3f0209a4.js"><link rel="prefetch" href="/assets/js/105.948b2aef.js"><link rel="prefetch" href="/assets/js/106.60df21fa.js"><link rel="prefetch" href="/assets/js/107.69a5fb84.js"><link rel="prefetch" href="/assets/js/108.1065fe4f.js"><link rel="prefetch" href="/assets/js/109.317baa1c.js"><link rel="prefetch" href="/assets/js/11.929fd9ab.js"><link rel="prefetch" href="/assets/js/110.b2e6f7b5.js"><link rel="prefetch" href="/assets/js/111.56c71e6f.js"><link rel="prefetch" href="/assets/js/112.8e251faa.js"><link rel="prefetch" href="/assets/js/113.22791a5e.js"><link rel="prefetch" href="/assets/js/114.f0c93263.js"><link rel="prefetch" href="/assets/js/115.ebfe5004.js"><link rel="prefetch" href="/assets/js/116.0cea80b9.js"><link rel="prefetch" href="/assets/js/12.727ba583.js"><link rel="prefetch" href="/assets/js/13.a8bde010.js"><link rel="prefetch" href="/assets/js/15.e4bbe0f4.js"><link rel="prefetch" href="/assets/js/16.cc817318.js"><link rel="prefetch" href="/assets/js/17.0a0c8d6a.js"><link rel="prefetch" href="/assets/js/18.ec87b88f.js"><link rel="prefetch" href="/assets/js/19.a58ec9cf.js"><link rel="prefetch" href="/assets/js/20.0d39f9bc.js"><link rel="prefetch" href="/assets/js/21.6f07b408.js"><link rel="prefetch" href="/assets/js/22.c378a752.js"><link rel="prefetch" href="/assets/js/23.19347616.js"><link rel="prefetch" href="/assets/js/24.9f9d9881.js"><link rel="prefetch" href="/assets/js/25.1c2cc3cf.js"><link rel="prefetch" href="/assets/js/26.5d1875ec.js"><link rel="prefetch" href="/assets/js/27.6bbd3bde.js"><link rel="prefetch" href="/assets/js/28.d3da88ff.js"><link rel="prefetch" href="/assets/js/29.bbf813ce.js"><link rel="prefetch" href="/assets/js/30.7ed0805b.js"><link rel="prefetch" href="/assets/js/31.9901af31.js"><link rel="prefetch" href="/assets/js/32.e6c9368c.js"><link rel="prefetch" href="/assets/js/33.6e4b49b5.js"><link rel="prefetch" href="/assets/js/34.8ace8562.js"><link rel="prefetch" href="/assets/js/35.b3deaab5.js"><link rel="prefetch" href="/assets/js/36.95cfa524.js"><link rel="prefetch" href="/assets/js/37.4979b86c.js"><link rel="prefetch" href="/assets/js/38.75dee435.js"><link rel="prefetch" href="/assets/js/39.857ceed0.js"><link rel="prefetch" href="/assets/js/40.897feca2.js"><link rel="prefetch" href="/assets/js/41.1a473a23.js"><link rel="prefetch" href="/assets/js/42.3e8c95c0.js"><link rel="prefetch" href="/assets/js/43.c5d7c801.js"><link rel="prefetch" href="/assets/js/44.83dd54ff.js"><link rel="prefetch" href="/assets/js/45.ad590474.js"><link rel="prefetch" href="/assets/js/46.b91552e2.js"><link rel="prefetch" href="/assets/js/47.95cc740d.js"><link rel="prefetch" href="/assets/js/48.7f6594f9.js"><link rel="prefetch" href="/assets/js/49.d3322e38.js"><link rel="prefetch" href="/assets/js/5.4e884bb2.js"><link rel="prefetch" href="/assets/js/50.9f605a22.js"><link rel="prefetch" href="/assets/js/51.11d368d7.js"><link rel="prefetch" href="/assets/js/52.05ca71be.js"><link rel="prefetch" href="/assets/js/53.1f796c38.js"><link rel="prefetch" href="/assets/js/54.47947853.js"><link rel="prefetch" href="/assets/js/55.728d8658.js"><link rel="prefetch" href="/assets/js/56.9a86f535.js"><link rel="prefetch" href="/assets/js/57.74e1b35f.js"><link rel="prefetch" href="/assets/js/58.1f376d1b.js"><link rel="prefetch" href="/assets/js/59.50aa535e.js"><link rel="prefetch" href="/assets/js/6.682ca71b.js"><link rel="prefetch" href="/assets/js/60.41cb13b1.js"><link rel="prefetch" href="/assets/js/61.69bb2d09.js"><link rel="prefetch" href="/assets/js/62.67b2fc04.js"><link rel="prefetch" href="/assets/js/63.95759024.js"><link rel="prefetch" href="/assets/js/64.7d72ca8f.js"><link rel="prefetch" href="/assets/js/65.4366f91c.js"><link rel="prefetch" href="/assets/js/66.a787feda.js"><link rel="prefetch" href="/assets/js/67.61ba77a5.js"><link rel="prefetch" href="/assets/js/68.c66fba78.js"><link rel="prefetch" href="/assets/js/69.fd5b3fde.js"><link rel="prefetch" href="/assets/js/7.176bb64e.js"><link rel="prefetch" href="/assets/js/70.934bad61.js"><link rel="prefetch" href="/assets/js/71.335d12f9.js"><link rel="prefetch" href="/assets/js/72.af1a8e71.js"><link rel="prefetch" href="/assets/js/73.e88e72d0.js"><link rel="prefetch" href="/assets/js/74.4f3b894b.js"><link rel="prefetch" href="/assets/js/75.fde96aec.js"><link rel="prefetch" href="/assets/js/76.af19bc3e.js"><link rel="prefetch" href="/assets/js/77.4c229e84.js"><link rel="prefetch" href="/assets/js/78.53a47c9a.js"><link rel="prefetch" href="/assets/js/79.3386820b.js"><link rel="prefetch" href="/assets/js/8.b72ec180.js"><link rel="prefetch" href="/assets/js/80.5c391ecb.js"><link rel="prefetch" href="/assets/js/81.f3e6d1c5.js"><link rel="prefetch" href="/assets/js/82.88af6d56.js"><link rel="prefetch" href="/assets/js/83.7643311a.js"><link rel="prefetch" href="/assets/js/84.63df80fe.js"><link rel="prefetch" href="/assets/js/85.f4abb638.js"><link rel="prefetch" href="/assets/js/87.1e253ac8.js"><link rel="prefetch" href="/assets/js/88.08313a09.js"><link rel="prefetch" href="/assets/js/89.455a2ff5.js"><link rel="prefetch" href="/assets/js/9.83648f97.js"><link rel="prefetch" href="/assets/js/90.859e04af.js"><link rel="prefetch" href="/assets/js/91.d82879a3.js"><link rel="prefetch" href="/assets/js/92.b5cb5c27.js"><link rel="prefetch" href="/assets/js/93.78b7c38a.js"><link rel="prefetch" href="/assets/js/94.fd60997e.js"><link rel="prefetch" href="/assets/js/95.1f637a1b.js"><link rel="prefetch" href="/assets/js/96.7a518867.js"><link rel="prefetch" href="/assets/js/97.fee8c50f.js"><link rel="prefetch" href="/assets/js/98.0d28b995.js"><link rel="prefetch" href="/assets/js/99.360a59a9.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.db62c372.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b020364b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>坤坤同学</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>关心你所关心的，与世界分享你的知识、经验和见闻</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="坤坤同学" class="logo"> <span class="site-name">坤坤同学</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    wanyakun
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>36</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>3</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/ios/" aria-current="page" class="sidebar-link">关于</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目经验</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三方库原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>提问</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Category和Extension</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Category和Extension</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>wanyakun</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>5/21/2021</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><ol><li>extension可以看做是category的一个特例，有时候又叫匿名分类，可以为类添加一些私有的成员变量和成员函数</li> <li>category可以在不改变原有类的基础上为类扩展方法，category不能添加成员变量，但可以通过实现其getter和setter方法的方式来添加，（通过OBJC_ASSOCIATE方式添加）</li> <li>extension通常写在.m文件中，定义的变量和方法都是私有的，也可以写在.h中，变量是共有变量</li> <li>extension中的方法一定要实现，category中的没有限制</li></ol> <h2 id="extension"><a href="#extension" class="header-anchor">#</a> Extension</h2> <p>extension看起来像一个匿名的category，但实际上几乎是完全不同的东西。extension是在编译期决定的，就是类的一部分，和Interface和Implement一起形成一个完整的类。extension一般用来隐藏类的私有信息，必须有源码才能添加extension，所以无法通过extension为系统的类添加extension。</p> <p>而category是在运行时决定的。这也就是为什么extension可以添加实例变量，而category不可以（因为在运行时，对象的内存布局已经确定，添加实例变量就会破坏类的内存布局）</p> <h2 id="category"><a href="#category" class="header-anchor">#</a> Category</h2> <p>category的主要作用是为已经存在的类添加方法</p> <blockquote><p>You use categories to define additional methods of an existing class—even one whose source code is unavailable to you—without subclassing. You typically use a category to add methods to an existing class, such as one defined in the Cocoa frameworks. The added methods are inherited by subclasses and are indistinguishable at runtime from the original methods of the class. You can also use categories of your own classes to:</p> <ul><li>Distribute the implementation of your own classes into separate source files—for example, you could group the methods of a large class into several categories and put each category in a different file.</li> <li>Declare private methods.</li></ul> <p>You add methods to a class by declaring them in an interface file under a category name and defining them in an implementation file under the same name. The category name indicates that the methods are an extension to a class declared elsewhere, not a new class.</p></blockquote> <p>官方推荐Category的两个使用场景：</p> <ul><li>可以把类的实现分开在不同的文件里面</li> <li>声明私有方法</li></ul> <h3 id="category结构分析"><a href="#category结构分析" class="header-anchor">#</a> Category结构分析</h3> <p>试着写一个Category，并用clang进行-rewrite-objc。首先在runtime源码中可以找到Category的结构体：<code>category_t</code> :</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">category_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>	<span class="token comment">// 类名</span>
    <span class="token class-name">classref_t</span> cls<span class="token punctuation">;</span>		<span class="token comment">// 类</span>
    <span class="token keyword">struct</span> <span class="token class-name">method_list_t</span> <span class="token operator">*</span>instanceMethods<span class="token punctuation">;</span>	<span class="token comment">// Category中给类添加的的实例方法列表</span>
    <span class="token keyword">struct</span> <span class="token class-name">method_list_t</span> <span class="token operator">*</span>classMethods<span class="token punctuation">;</span>			<span class="token comment">// category中给类添加的类方法类别</span>
    <span class="token keyword">struct</span> <span class="token class-name">protocol_list_t</span> <span class="token operator">*</span>protocols<span class="token punctuation">;</span>			<span class="token comment">// category中实现的协议列表</span>
    <span class="token keyword">struct</span> <span class="token class-name">property_list_t</span> <span class="token operator">*</span>instanceProperties<span class="token punctuation">;</span>		<span class="token comment">// category中添加的属性</span>
    <span class="token comment">// Fields below this point are not always present on disk.</span>
    <span class="token keyword">struct</span> <span class="token class-name">property_list_t</span> <span class="token operator">*</span>_classProperties<span class="token punctuation">;</span>

    <span class="token class-name">method_list_t</span> <span class="token operator">*</span><span class="token function">methodsForMeta</span><span class="token punctuation">(</span>bool isMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isMeta<span class="token punctuation">)</span> <span class="token keyword">return</span> classMethods<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> instanceMethods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">property_list_t</span> <span class="token operator">*</span><span class="token function">propertiesForMeta</span><span class="token punctuation">(</span>bool isMeta<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">header_info</span> <span class="token operator">*</span>hi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">protocol_list_t</span> <span class="token operator">*</span><span class="token function">protocolsForMeta</span><span class="token punctuation">(</span>bool isMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isMeta<span class="token punctuation">)</span> <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> protocols<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>从Category的结构体可以看出，可以添加实例方法、类方法、实现协议、添加属性，而不能够添加实例变量。</p> <p>写一个Category：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token expression"><span class="token operator">&lt;</span>Foundation<span class="token operator">/</span>Foundation<span class="token punctuation">.</span>h<span class="token operator">&gt;</span></span></span>

NS_ASSUME_NONNULL_BEGIN

<span class="token keyword">@interface</span> YKDemoClass <span class="token punctuation">:</span> NSObject

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printName<span class="token punctuation">;</span>

<span class="token keyword">@end</span>

<span class="token keyword">@interface</span> <span class="token function">YKDemoClass</span> <span class="token punctuation">(</span>Addtion<span class="token punctuation">)</span><span class="token operator">&lt;</span>NSCopying<span class="token operator">&gt;</span>

<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>addName<span class="token punctuation">;</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printName<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printAddName<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printClasName<span class="token punctuation">;</span>

<span class="token keyword">@end</span>

<span class="token keyword">@interface</span> <span class="token function">YKDemoClass</span> <span class="token punctuation">(</span>MyAddtion<span class="token punctuation">)</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printMyAddtionName<span class="token punctuation">;</span>

<span class="token keyword">@end</span>

NS_ASSUME_NONNULL_END

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">&quot;YKDemoClass.h&quot;</span></span>

<span class="token keyword">@implementation</span> YKDemoClass

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printName <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token string">@&quot;DemoClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> <span class="token function">YKDemoClass</span> <span class="token punctuation">(</span>Addtion<span class="token punctuation">)</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printName <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token string">@&quot;AddtionDemoClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printAddName <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token string">@&quot;Addtion&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printClasName <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token string">@&quot;YKDemoClass+Addtion&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>copyWithZone<span class="token punctuation">:</span><span class="token punctuation">(</span>nullable NSZone <span class="token operator">*</span><span class="token punctuation">)</span>zone <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token string">@&quot;copyWithZone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> <span class="token function">YKDemoClass</span> <span class="token punctuation">(</span>MyAddtion<span class="token punctuation">)</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>printMyAddtionName <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token string">@&quot;MyAddtion&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>使用clang命令进行处理得到cpp <code>clang -rewrite-objc YKDemoClass.m</code>，在文件最后找到如下代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_method_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _objc_method)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> method_count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_objc_method</span> method_list<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_CATEGORY_INSTANCE_METHODS_YKDemoClass_$_Addtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_objc_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;printName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v16@0:8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_I_YKDemoClass_Addtion_printName<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;printAddName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v16@0:8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_I_YKDemoClass_Addtion_printAddName<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;copyWithZone:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@24@0:8^{_NSZone=}16&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_I_YKDemoClass_Addtion_copyWithZone_<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_method_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _objc_method)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> method_count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_objc_method</span> method_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_CATEGORY_CLASS_METHODS_YKDemoClass_$_Addtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_objc_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;printClasName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v16@0:8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_C_YKDemoClass_Addtion_printClasName<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>_OBJC_PROTOCOL_METHOD_TYPES_NSCopying <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
<span class="token punctuation">{</span>
	<span class="token string">&quot;@24@0:8^{_NSZone=}16&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_method_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _objc_method)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> method_count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_objc_method</span> method_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_PROTOCOL_INSTANCE_METHODS_NSCopying <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_objc_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;copyWithZone:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@24@0:8^{_NSZone=}16&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_protocol_t</span> _OBJC_PROTOCOL_NSCopying <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string">&quot;NSCopying&quot;</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">method_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_PROTOCOL_INSTANCE_METHODS_NSCopying<span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_protocol_t<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_PROTOCOL_METHOD_TYPES_NSCopying
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">_protocol_t</span> <span class="token operator">*</span>_OBJC_LABEL_PROTOCOL_$_NSCopying <span class="token operator">=</span> <span class="token operator">&amp;</span>_OBJC_PROTOCOL_NSCopying<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_protocol_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">long</span> protocol_count<span class="token punctuation">;</span>  <span class="token comment">// Note, this is 32/64 bit</span>
	<span class="token keyword">struct</span> <span class="token class-name">_protocol_t</span> <span class="token operator">*</span>super_protocols<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_CATEGORY_PROTOCOLS_$_YKDemoClass_$_Addtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>_OBJC_PROTOCOL_NSCopying
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_prop_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _prop_t)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> count_of_properties<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_prop_t</span> prop_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_PROP_LIST_YKDemoClass_$_Addtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_prop_t<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">&quot;addName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;T@\&quot;NSString\&quot;,C,N&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token class-name">_class_t</span> OBJC_CLASS_$_YKDemoClass<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">_category_t</span> _OBJC_$_CATEGORY_YKDemoClass_$_Addtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
<span class="token punctuation">{</span>
	<span class="token string">&quot;YKDemoClass&quot;</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// &amp;OBJC_CLASS_$_YKDemoClass,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_method_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_CATEGORY_INSTANCE_METHODS_YKDemoClass_$_Addtion<span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_method_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_CATEGORY_CLASS_METHODS_YKDemoClass_$_Addtion<span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_protocol_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_CATEGORY_PROTOCOLS_$_YKDemoClass_$_Addtion<span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_prop_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_PROP_LIST_YKDemoClass_$_Addtion<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> OBJC_CATEGORY_SETUP_$_YKDemoClass_$<span class="token function">_Addtion</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_OBJC_$_CATEGORY_YKDemoClass_$_Addtion<span class="token punctuation">.</span>cls <span class="token operator">=</span> <span class="token operator">&amp;</span>OBJC_CLASS_$_YKDemoClass<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_method_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _objc_method)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> method_count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_objc_method</span> method_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_CATEGORY_INSTANCE_METHODS_YKDemoClass_$_MyAddtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_objc_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;printMyAddtionName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v16@0:8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_I_YKDemoClass_MyAddtion_printMyAddtionName<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token class-name">_class_t</span> OBJC_CLASS_$_YKDemoClass<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">_category_t</span> _OBJC_$_CATEGORY_YKDemoClass_$_MyAddtion <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
<span class="token punctuation">{</span>
	<span class="token string">&quot;YKDemoClass&quot;</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// &amp;OBJC_CLASS_$_YKDemoClass,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_method_list_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_CATEGORY_INSTANCE_METHODS_YKDemoClass_$_MyAddtion<span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> OBJC_CATEGORY_SETUP_$_YKDemoClass_$<span class="token function">_MyAddtion</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_OBJC_$_CATEGORY_YKDemoClass_$_MyAddtion<span class="token punctuation">.</span>cls <span class="token operator">=</span> <span class="token operator">&amp;</span>OBJC_CLASS_$_YKDemoClass<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">section</span><span class="token punctuation">(</span></span><span class="token string">&quot;.objc_inithooks$B&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">)</span></span></span>
<span class="token function">__declspec</span><span class="token punctuation">(</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token string">&quot;.objc_inithooks$B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>OBJC_CATEGORY_SETUP<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>OBJC_CATEGORY_SETUP_$_YKDemoClass_$_Addtion<span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>OBJC_CATEGORY_SETUP_$_YKDemoClass_$_MyAddtion<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">_class_t</span> <span class="token operator">*</span>L_OBJC_LABEL_CLASS_$ <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA, __objc_classlist,regular,no_dead_strip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>OBJC_CLASS_$_YKDemoClass<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">_category_t</span> <span class="token operator">*</span>L_OBJC_LABEL_CATEGORY_$ <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">&quot;__DATA, __objc_catlist,regular,no_dead_strip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>_OBJC_$_CATEGORY_YKDemoClass_$_Addtion<span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>_OBJC_$_CATEGORY_YKDemoClass_$_MyAddtion<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><p>从代码中可以看到：</p> <ol><li><p>生成了以下结构  :</p> <ul><li><p>实例方法列表： <code>_OBJC_$_CATEGORY_INSTANCE_METHODS_YKDemoClass_$_Addtion</code></p></li> <li><p>类方法列表： <code>_OBJC_$_CATEGORY_CLASS_METHODS_YKDemoClass_$_Addtion</code></p></li> <li><p>实现的协议列表： <code>_OBJC_CATEGORY_PROTOCOLS_$_YKDemoClass_$_Addtion</code></p></li> <li><p>属性列表: <code>_OBJC_$_PROP_LIST_YKDemoClass_$_Addtion</code></p></li></ul> <p>而且有static修饰，所以在同一个编译单元中，Category名称不能重复</p></li> <li><p>生成了名字为<code>_OBJC_$_CATEGORY_YKDemoClass_$_Addtion</code>的<code>_category_t</code>结构体，并用1中的实例方法列表、类方法列表、协议列表和属性列表进行初始化</p></li> <li><p>在DATA段<code>__objc_catlist</code>里保存了大小为2的<code>_category_t</code>的数组<code>L_OBJC_LABEL_CATEGORY_$</code>(我们添加了两个Category)</p></li></ol> <h3 id="category加载过程"><a href="#category加载过程" class="header-anchor">#</a> Category加载过程</h3> <p>要想弄清楚Category的加载过程，可以先了解下App启动过程，App启动时先加载dyld（动态库加载器），执行<code>_dyld_start</code>，然后加载动态库（Image），ImageLoader对Image进行初始化，调用<code>libSystem_initializer</code>，之后会调用runtime里的<code>_objc_init</code>方法，注册image的三个回调函数map、init和unmap。在XCode中Debug一下就可以发现，dyld的源码就不贴了，回头专门写一篇文章</p> <p><img src="/assets/img/ios/basic/map-images.png" alt="map-images"></p> <p><img src="/assets/img/ios/basic/load-images.png" alt="load-images"></p> <p><img src="/assets/img/ios/basic/load-images-2.png" alt="load-images-2"></p> <p>而<code>_dyld_objc_notify_register</code>可以在在objc-os.mm中可以找到OC运行的入口方法：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/***********************************************************************
* _objc_init
* Bootstrap initialization. Registers our image notifier with dyld.
* Called by libSystem BEFORE library initialization time
**********************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">_objc_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> bool initialized <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    initialized <span class="token operator">=</span> true<span class="token punctuation">;</span>
    
    <span class="token comment">// fixme defer initialization until an objc-using image is found?</span>
    <span class="token function">environ_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tls_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">static_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runtime_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exception_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cache_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_imp_implementationWithBlock_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//_dyld_objc_notify_register注册三个回调函数，</span>
    <span class="token comment">// map_images：dyld将image加载到内存时调用 </span>
    <span class="token comment">// load_images：dyld初始化image，load方法都在此时调用</span>
    <span class="token comment">// unmap_image：将image移除内存时调用</span>
    <span class="token comment">// map_images这个方法，用来处理被dyld映射过来的镜像，注册后就会被调用</span>
    <span class="token function">_dyld_objc_notify_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>map_images<span class="token punctuation">,</span> load_images<span class="token punctuation">,</span> unmap_image<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__OBJC2__</span></span>
    didCallDyldNotifyRegister <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>刚开始以为category被附加到类中是在函数<code>map_images</code>执行过中，其实不然。</p> <p>首先我们看<code>map_images</code>方法，dyld会调用<code>map_images</code>函数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> objcImageCount <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		dyld3<span class="token operator">::</span>ScopedTimer <span class="token function">timer</span><span class="token punctuation">(</span>DBG_DYLD_TIMING_OBJC_MAP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">uint64_t</span> t0 <span class="token operator">=</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>sNotifyObjCMapped<span class="token punctuation">)</span><span class="token punctuation">(</span>objcImageCount<span class="token punctuation">,</span> paths<span class="token punctuation">,</span> mhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">uint64_t</span> t1 <span class="token operator">=</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ImageLoader<span class="token operator">::</span>fgTotalObjCSetupTime <span class="token operator">+=</span> <span class="token punctuation">(</span>t1<span class="token operator">-</span>t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其中<code>(*sNotifyObjCMapped)(objcImageCount, paths, mhs);</code>就是调用<code>map_images</code>函数，我们回到runtime中看<code>map_images</code>执行过程，而在objc-runtime-new.h中显示其实是调用了<code>map_images_nolock</code>，这个方法代码很多，截取关键代码如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>hCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_read_images</span><span class="token punctuation">(</span>hList<span class="token punctuation">,</span> hCount<span class="token punctuation">,</span> totalClasses<span class="token punctuation">,</span> unoptimizedTotalClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>发现其实是调用<code>_read_images</code>方法，这个方法更长，包含了很多功能：发现Class、Protocol，Category等等</p> <p>而其中一部分就是发现Category的，如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// Discover categories. Only do this after the initial category</span>
<span class="token comment">// attachment has been done. For categories present at startup,</span>
<span class="token comment">// discovery is deferred until the first load_images call after</span>
<span class="token comment">// the call to _dyld_objc_notify_register completes. rdar://problem/53119145</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>didInitialAttachCategories<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>EACH_HEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">load_categories_nolock</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>从注释可以看到：只有在分类初始化并将数据加载类后才执行，对于运行时出现的分类，将分类的发现推迟到<code>_dyld_objc_notify_register</code>方法完成后的第一次<code>load_images</code>调用。</p> <p>因为<code>didInitialAttachCategories</code>的默认值为false，而 Attach categories是在后面调用<code>realizeClassWithoutSwift</code>时的最后一步做的，我们接着看<code>load_images</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/***********************************************************************
* load_images
* Process +load in the given images which are being mapped in by dyld.
*
* Locking: write-locks runtimeLock and loadMethodLock
**********************************************************************/</span>
<span class="token keyword">extern</span> bool <span class="token function">hasLoadMethods</span><span class="token punctuation">(</span><span class="token keyword">const</span> headerType <span class="token operator">*</span>mhdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">prepare_load_methods</span><span class="token punctuation">(</span><span class="token keyword">const</span> headerType <span class="token operator">*</span>mhdr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>
<span class="token function">load_images</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path __unused<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">mach_header</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didInitialAttachCategories <span class="token operator">&amp;&amp;</span> didCallDyldNotifyRegister<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didInitialAttachCategories <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token function">loadAllCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Return without taking locks if there are no +load methods here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasLoadMethods</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> headerType <span class="token operator">*</span><span class="token punctuation">)</span>mh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token class-name">recursive_mutex_locker_t</span> <span class="token function">lock</span><span class="token punctuation">(</span>loadMethodLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Discover load methods</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">mutex_locker_t</span> <span class="token function">lock2</span><span class="token punctuation">(</span>runtimeLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">prepare_load_methods</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> headerType <span class="token operator">*</span><span class="token punctuation">)</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Call +load methods (without runtimeLock - re-entrant)</span>
    <span class="token function">call_load_methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>首先<code>didInitialAttachCategories</code>的默认值为false，<code>didCallDyldNotifyRegister</code>的值是在<code>_dyld_objc_notify_register</code>结束后设置为true的，也印证了上面<code>_read_images</code>中的解释。</p> <p>而<code>loadAllCategories</code>方法会循环调用<code>load_categories_nolock</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">load_categories_nolock</span><span class="token punctuation">(</span>header_info <span class="token operator">*</span>hi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool hasClassProperties <span class="token operator">=</span> hi<span class="token operator">-&gt;</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">hasCategoryClassProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> count<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> processCatlist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">category_t</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span>catlist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">category_t</span> <span class="token operator">*</span>cat <span class="token operator">=</span> catlist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            Class cls <span class="token operator">=</span> <span class="token function">remapClass</span><span class="token punctuation">(</span>cat<span class="token operator">-&gt;</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">locstamped_category_t</span> lc<span class="token punctuation">{</span>cat<span class="token punctuation">,</span> hi<span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Category's target class is missing (probably weak-linked).</span>
                <span class="token comment">// Ignore the category.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintConnecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">_objc_inform</span><span class="token punctuation">(</span><span class="token string">&quot;CLASS: IGNORING category \?\?\?(%s) %p with &quot;</span>
                                 <span class="token string">&quot;missing weak-linked target class&quot;</span><span class="token punctuation">,</span>
                                 cat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> cat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Process this category.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span><span class="token function">isStubClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Stub classes are never realized. Stub classes</span>
                <span class="token comment">// don't know their metaclass until they're</span>
                <span class="token comment">// initialized, so we have to add categories with</span>
                <span class="token comment">// class methods or properties to the stub itself.</span>
                <span class="token comment">// methodizeClass() will find them and add them to</span>
                <span class="token comment">// the metaclass as appropriate.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cat<span class="token operator">-&gt;</span>instanceMethods <span class="token operator">||</span>
                    cat<span class="token operator">-&gt;</span>protocols <span class="token operator">||</span>
                    cat<span class="token operator">-&gt;</span>instanceProperties <span class="token operator">||</span>
                    cat<span class="token operator">-&gt;</span>classMethods <span class="token operator">||</span>
                    cat<span class="token operator">-&gt;</span>protocols <span class="token operator">||</span>
                    <span class="token punctuation">(</span>hasClassProperties <span class="token operator">&amp;&amp;</span> cat<span class="token operator">-&gt;</span>_classProperties<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    objc<span class="token operator">::</span>unattachedCategories<span class="token punctuation">.</span><span class="token function">addForClass</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// First, register the category with its target class.</span>
                <span class="token comment">// Then, rebuild the class's method lists (etc) if</span>
                <span class="token comment">// the class is realized.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cat<span class="token operator">-&gt;</span>instanceMethods <span class="token operator">||</span>  cat<span class="token operator">-&gt;</span>protocols
                    <span class="token operator">||</span>  cat<span class="token operator">-&gt;</span>instanceProperties<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span><span class="token function">isRealized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">attachCategories</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ATTACH_EXISTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        objc<span class="token operator">::</span>unattachedCategories<span class="token punctuation">.</span><span class="token function">addForClass</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>cat<span class="token operator">-&gt;</span>classMethods  <span class="token operator">||</span>  cat<span class="token operator">-&gt;</span>protocols
                    <span class="token operator">||</span>  <span class="token punctuation">(</span>hasClassProperties <span class="token operator">&amp;&amp;</span> cat<span class="token operator">-&gt;</span>_classProperties<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span><span class="token function">ISA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">isRealized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">attachCategories</span><span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span><span class="token function">ISA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>lc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ATTACH_EXISTING <span class="token operator">|</span> ATTACH_METACLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        objc<span class="token operator">::</span>unattachedCategories<span class="token punctuation">.</span><span class="token function">addForClass</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span> cls<span class="token operator">-&gt;</span><span class="token function">ISA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">processCatlist</span><span class="token punctuation">(</span>hi<span class="token operator">-&gt;</span><span class="token function">catlist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">processCatlist</span><span class="token punctuation">(</span>hi<span class="token operator">-&gt;</span><span class="token function">catlist2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>这里做的事情就是读取category_t数组，分别将实例方法和类方法添加到cls上和cls的ISA上，分别调用<code>attachCategories</code>方法：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// Attach method lists and properties and protocols from categories to a class.</span>
<span class="token comment">// Assumes the categories in cats are all loaded and sorted by load order, </span>
<span class="token comment">// oldest categories first.</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">attachCategories</span><span class="token punctuation">(</span>Class cls<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">locstamped_category_t</span> <span class="token operator">*</span>cats_list<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> cats_count<span class="token punctuation">,</span>
                 <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>PrintReplacedMethods<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printReplacements</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> cats_list<span class="token punctuation">,</span> cats_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>PrintConnecting<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_objc_inform</span><span class="token punctuation">(</span><span class="token string">&quot;CLASS: attaching %d categories to%s class '%s'%s&quot;</span><span class="token punctuation">,</span>
                     cats_count<span class="token punctuation">,</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ATTACH_EXISTING<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot; existing&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                     cls<span class="token operator">-&gt;</span><span class="token function">nameForLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ATTACH_METACLASS<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot; (meta)&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Only a few classes have more than 64 categories during launch.
     * This uses a little stack, and avoids malloc.
     *
     * Categories must be added in the proper order, which is back
     * to front. To do that with the chunking, we iterate cats_list
     * from front to back, build up the local buffers backwards,
     * and call attachLists on the chunks. attachLists prepends the
     * lists, so the final result is in the expected order.
     */</span>
    constexpr <span class="token class-name">uint32_t</span> ATTACH_BUFSIZ <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token class-name">method_list_t</span>   <span class="token operator">*</span>mlists<span class="token punctuation">[</span>ATTACH_BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">property_list_t</span> <span class="token operator">*</span>proplists<span class="token punctuation">[</span>ATTACH_BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">protocol_list_t</span> <span class="token operator">*</span>protolists<span class="token punctuation">[</span>ATTACH_BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token class-name">uint32_t</span> mcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> propcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> protocount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bool fromBundle <span class="token operator">=</span> NO<span class="token punctuation">;</span>
    bool isMeta <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ATTACH_METACLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> rwe <span class="token operator">=</span> cls<span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">extAllocIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cats_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry <span class="token operator">=</span> cats_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token class-name">method_list_t</span> <span class="token operator">*</span>mlist <span class="token operator">=</span> entry<span class="token punctuation">.</span>cat<span class="token operator">-&gt;</span><span class="token function">methodsForMeta</span><span class="token punctuation">(</span>isMeta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mlist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mcount <span class="token operator">==</span> ATTACH_BUFSIZ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">prepareMethodLists</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> mlists<span class="token punctuation">,</span> mcount<span class="token punctuation">,</span> NO<span class="token punctuation">,</span> fromBundle<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rwe<span class="token operator">-&gt;</span>methods<span class="token punctuation">.</span><span class="token function">attachLists</span><span class="token punctuation">(</span>mlists<span class="token punctuation">,</span> mcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mlists<span class="token punctuation">[</span>ATTACH_BUFSIZ <span class="token operator">-</span> <span class="token operator">++</span>mcount<span class="token punctuation">]</span> <span class="token operator">=</span> mlist<span class="token punctuation">;</span>
            fromBundle <span class="token operator">|=</span> entry<span class="token punctuation">.</span>hi<span class="token operator">-&gt;</span><span class="token function">isBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">property_list_t</span> <span class="token operator">*</span>proplist <span class="token operator">=</span>
            entry<span class="token punctuation">.</span>cat<span class="token operator">-&gt;</span><span class="token function">propertiesForMeta</span><span class="token punctuation">(</span>isMeta<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>hi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proplist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propcount <span class="token operator">==</span> ATTACH_BUFSIZ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rwe<span class="token operator">-&gt;</span>properties<span class="token punctuation">.</span><span class="token function">attachLists</span><span class="token punctuation">(</span>proplists<span class="token punctuation">,</span> propcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                propcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            proplists<span class="token punctuation">[</span>ATTACH_BUFSIZ <span class="token operator">-</span> <span class="token operator">++</span>propcount<span class="token punctuation">]</span> <span class="token operator">=</span> proplist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">protocol_list_t</span> <span class="token operator">*</span>protolist <span class="token operator">=</span> entry<span class="token punctuation">.</span>cat<span class="token operator">-&gt;</span><span class="token function">protocolsForMeta</span><span class="token punctuation">(</span>isMeta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>protolist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>protocount <span class="token operator">==</span> ATTACH_BUFSIZ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rwe<span class="token operator">-&gt;</span>protocols<span class="token punctuation">.</span><span class="token function">attachLists</span><span class="token punctuation">(</span>protolists<span class="token punctuation">,</span> protocount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                protocount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            protolists<span class="token punctuation">[</span>ATTACH_BUFSIZ <span class="token operator">-</span> <span class="token operator">++</span>protocount<span class="token punctuation">]</span> <span class="token operator">=</span> protolist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mcount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">prepareMethodLists</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> mlists <span class="token operator">+</span> ATTACH_BUFSIZ <span class="token operator">-</span> mcount<span class="token punctuation">,</span> mcount<span class="token punctuation">,</span>
                           NO<span class="token punctuation">,</span> fromBundle<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rwe<span class="token operator">-&gt;</span>methods<span class="token punctuation">.</span><span class="token function">attachLists</span><span class="token punctuation">(</span>mlists <span class="token operator">+</span> ATTACH_BUFSIZ <span class="token operator">-</span> mcount<span class="token punctuation">,</span> mcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ATTACH_EXISTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">flushCaches</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Class c<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// constant caches have been dealt with in prepareMethodLists</span>
                <span class="token comment">// if the class still is constant here, it's fine to keep</span>
                <span class="token keyword">return</span> <span class="token operator">!</span>c<span class="token operator">-&gt;</span>cache<span class="token punctuation">.</span><span class="token function">isConstantOptimizedCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    rwe<span class="token operator">-&gt;</span>properties<span class="token punctuation">.</span><span class="token function">attachLists</span><span class="token punctuation">(</span>proplists <span class="token operator">+</span> ATTACH_BUFSIZ <span class="token operator">-</span> propcount<span class="token punctuation">,</span> propcount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    rwe<span class="token operator">-&gt;</span>protocols<span class="token punctuation">.</span><span class="token function">attachLists</span><span class="token punctuation">(</span>protolists <span class="token operator">+</span> ATTACH_BUFSIZ <span class="token operator">-</span> protocount<span class="token punctuation">,</span> protocount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>这里才是真正添加方法、属性和协议的地方，通过列表的<code>attachLists</code>方法进行添加，此方法就比较简单了：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">attachLists</span><span class="token punctuation">(</span>List<span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span> addedLists<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> addedCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addedCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// many lists -&gt; many lists</span>
        <span class="token class-name">uint32_t</span> oldCount <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>count<span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span> newCount <span class="token operator">=</span> oldCount <span class="token operator">+</span> addedCount<span class="token punctuation">;</span>
        <span class="token class-name">array_t</span> <span class="token operator">*</span>newArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">array_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token class-name">array_t</span><span class="token operator">::</span><span class="token function">byteSize</span><span class="token punctuation">(</span>newCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newArray<span class="token operator">-&gt;</span>count <span class="token operator">=</span> newCount<span class="token punctuation">;</span>
        <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>count <span class="token operator">=</span> newCount<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> oldCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
            newArray<span class="token operator">-&gt;</span>lists<span class="token punctuation">[</span>i <span class="token operator">+</span> addedCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> addedCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            newArray<span class="token operator">-&gt;</span>lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> addedLists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list  <span class="token operator">&amp;&amp;</span>  addedCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 0 lists -&gt; 1 list</span>
        list <span class="token operator">=</span> addedLists<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 list -&gt; many lists</span>
        Ptr<span class="token operator">&lt;</span>List<span class="token operator">&gt;</span> oldList <span class="token operator">=</span> list<span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span> oldCount <span class="token operator">=</span> oldList <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span> newCount <span class="token operator">=</span> oldCount <span class="token operator">+</span> addedCount<span class="token punctuation">;</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">array_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token class-name">array_t</span><span class="token operator">::</span><span class="token function">byteSize</span><span class="token punctuation">(</span>newCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>count <span class="token operator">=</span> newCount<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldList<span class="token punctuation">)</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>lists<span class="token punctuation">[</span>addedCount<span class="token punctuation">]</span> <span class="token operator">=</span> oldList<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> addedCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> addedLists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>注意：</strong></p> <ol><li>从整个加载过程来看，category的方法没有替换掉原来已经存在的方法，比如category和原来的类都有print这个方法，那么category附加完成后，类的方法列表中会有两个print方法</li> <li>category中的方法在新的方法列表中排在了前面，而原来类中的方法被放到了新方法列表的后面。也就是说越晚加载的category，其方法在方法列表中排列越靠前，而在方法调用的时候则是顺着方法列表查找，这也就是我们所说的category的方法会“覆盖”掉原来类中同名方法的原因。</li></ol> <h3 id="category和-load方法"><a href="#category和-load方法" class="header-anchor">#</a> Category和+load方法</h3> <p>在类中和category中都可以有+load方法，那有两个问题：</p> <ol><li><p>在类的+load方法调用的时候，可以调用category中的方法吗？</p> <p>可以调用，从源码来看，附加category到类的工作是先于+load方法执行的</p></li> <li><p>这些+load方法的调用顺序是什么样的？</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/***********************************************************************
* call_load_methods
* Call all pending class and category +load methods.
* Class +load methods are called superclass-first. 
* Category +load methods are not called until after the parent class's +load.
* 
* This method must be RE-ENTRANT, because a +load could trigger 
* more image mapping. In addition, the superclass-first ordering 
* must be preserved in the face of re-entrant calls. Therefore, 
* only the OUTERMOST call of this function will do anything, and 
* that call will handle all loadable classes, even those generated 
* while it was running.
*
* The sequence below preserves +load ordering in the face of 
* image loading during a +load, and make sure that no 
* +load method is forgotten because it was added during 
* a +load call.
* Sequence:
* 1. Repeatedly call class +loads until there aren't any more
* 2. Call category +loads ONCE.
* 3. Run more +loads if:
*    (a) there are more classes to load, OR
*    (b) there are some potential category +loads that have 
*        still never been attempted.
* Category +loads are only run once to ensure &quot;parent class first&quot; 
* ordering, even if a category +load triggers a new loadable class 
* and a new loadable category attached to that class. 
*
* Locking: loadMethodLock must be held by the caller 
*   All other locks must not be held.
**********************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">call_load_methods</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> bool loading <span class="token operator">=</span> NO<span class="token punctuation">;</span>
    bool more_categories<span class="token punctuation">;</span>

    loadMethodLock<span class="token punctuation">.</span><span class="token function">assertLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    loading <span class="token operator">=</span> YES<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token operator">*</span>pool <span class="token operator">=</span> <span class="token function">objc_autoreleasePoolPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. Repeatedly call class +loads until there aren't any more</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>loadable_classes_used <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">call_class_loads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. Call category +loads ONCE</span>
        more_categories <span class="token operator">=</span> <span class="token function">call_category_loads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. Run more +loads if there are classes OR more untried categories</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>loadable_classes_used <span class="token operator">&gt;</span> <span class="token number">0</span>  <span class="token operator">||</span>  more_categories<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">objc_autoreleasePoolPop</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>

    loading <span class="token operator">=</span> NO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div></li></ol> <p>从源码来看，先执行类的+load方法，再执行category的+load，而category的+load方法顺序是根据编译顺序而定的。</p> <h3 id="category和方法覆盖"><a href="#category和方法覆盖" class="header-anchor">#</a> Category和方法覆盖</h3> <p>在<a href="#category%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B">category加载过程</a>中已经讲了产生方法覆盖的原因，那我们如何调用到被覆盖的方法呢？</p> <p>其实类中的方法并不是被替换，只是category在方法列表的前面而已，所以可以顺着方法列表往后找到最后一个，就是原来类中的方法：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">void</span> <span class="token function">callOriginPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Class cls <span class="token operator">=</span> <span class="token punctuation">[</span>YKDemoClass class<span class="token punctuation">]</span><span class="token punctuation">;</span>
    YKDemoClass <span class="token operator">*</span>demo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>YKDemoClass alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> methodCount<span class="token punctuation">;</span>
    Method <span class="token operator">*</span>methodList <span class="token operator">=</span> <span class="token function">class_copyMethodList</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">&amp;</span>methodCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IMP lastImp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SEL lastSel <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>NSInteger i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> methodCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Method method <span class="token operator">=</span> methodList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        NSString <span class="token operator">*</span>methodName <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithCString<span class="token punctuation">:</span><span class="token function">sel_getName</span><span class="token punctuation">(</span><span class="token function">method_getName</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> encoding<span class="token punctuation">:</span>NSUTF8StringEncoding<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">@&quot;printName&quot;</span> isEqualToString<span class="token punctuation">:</span>methodName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastImp <span class="token operator">=</span> <span class="token function">method_getImplementation</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastSel <span class="token operator">=</span> <span class="token function">method_getName</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>PrintMethod<span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastImp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PrintMethod printMethod <span class="token operator">=</span> <span class="token punctuation">(</span>PrintMethod<span class="token punctuation">)</span>lastImp<span class="token punctuation">;</span>
        <span class="token function">printMethod</span><span class="token punctuation">(</span>demo<span class="token punctuation">,</span> lastSel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>methodList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="category和关联对象"><a href="#category和关联对象" class="header-anchor">#</a> Category和关联对象</h3> <p>category里面无法添加实例变量，但是我们很多时候需要在category中添加和对象关联的值，这个时候就需要用到关联对象来实现了。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setAddName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>addName <span class="token punctuation">{</span>
    <span class="token function">objc_setAssociatedObject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">@selector</span><span class="token punctuation">(</span>addName<span class="token punctuation">)</span><span class="token punctuation">,</span> addName<span class="token punctuation">,</span> OBJC_ASSOCIATION_COPY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>addName <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">objc_getAssociatedObject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">@selector</span><span class="token punctuation">(</span>addName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>再次查看runtime源码，<code>objc_setAssociatedObject</code>调用objc-references.mm中的<code>_object_set_associative_reference</code>方法：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">_object_set_associative_reference</span><span class="token punctuation">(</span>id object<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> id value<span class="token punctuation">,</span> <span class="token class-name">uintptr_t</span> policy<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// This code used to work when nil was passed for object and key. Some code</span>
    <span class="token comment">// probably relies on that to not crash. Check and handle it explicitly.</span>
    <span class="token comment">// rdar://problem/44094390</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>object <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getIsa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">forbidsAssociatedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">_objc_fatal</span><span class="token punctuation">(</span><span class="token string">&quot;objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span> <span class="token function">object_getClassName</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    DisguisedPtr<span class="token operator">&lt;</span>objc_object<span class="token operator">&gt;</span> disguised<span class="token punctuation">{</span><span class="token punctuation">(</span>objc_object <span class="token operator">*</span><span class="token punctuation">)</span>object<span class="token punctuation">}</span><span class="token punctuation">;</span>
    ObjcAssociation association<span class="token punctuation">{</span>policy<span class="token punctuation">,</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// retain the new value (if any) outside the lock.</span>
    association<span class="token punctuation">.</span><span class="token function">acquireValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    bool isFirstAssociation <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        AssociationsManager manager<span class="token punctuation">;</span>
        AssociationsHashMap <span class="token operator">&amp;</span><span class="token function">associations</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> refs_result <span class="token operator">=</span> associations<span class="token punctuation">.</span><span class="token function">try_emplace</span><span class="token punctuation">(</span>disguised<span class="token punctuation">,</span> ObjectAssociationMap<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>refs_result<span class="token punctuation">.</span>second<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* it's the first association we make */</span>
                isFirstAssociation <span class="token operator">=</span> true<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* establish or replace the association */</span>
            <span class="token keyword">auto</span> <span class="token operator">&amp;</span>refs <span class="token operator">=</span> refs_result<span class="token punctuation">.</span>first<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
            <span class="token keyword">auto</span> result <span class="token operator">=</span> refs<span class="token punctuation">.</span><span class="token function">try_emplace</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>association<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>second<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                association<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>first<span class="token operator">-&gt;</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> refs_it <span class="token operator">=</span> associations<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>disguised<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>refs_it <span class="token operator">!=</span> associations<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">auto</span> <span class="token operator">&amp;</span>refs <span class="token operator">=</span> refs_it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
                <span class="token keyword">auto</span> it <span class="token operator">=</span> refs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> refs<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    association<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    refs<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>refs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        associations<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>refs_it<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Call setHasAssociatedObjects outside the lock, since this</span>
    <span class="token comment">// will call the object's _noteAssociatedObjects method if it</span>
    <span class="token comment">// has one, and this may trigger +initialize which might do</span>
    <span class="token comment">// arbitrary stuff, including setting more associated objects.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirstAssociation<span class="token punctuation">)</span>
        object<span class="token operator">-&gt;</span><span class="token function">setHasAssociatedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// release the old value (outside of the lock).</span>
    association<span class="token punctuation">.</span><span class="token function">releaseHeldValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>可以看到关联对象都是由<code>AssociationsManager</code>管理，而<code>AssociationsManager</code>定义如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> DenseMap<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> ObjcAssociation<span class="token operator">&gt;</span> ObjectAssociationMap<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> DenseMap<span class="token operator">&lt;</span>DisguisedPtr<span class="token operator">&lt;</span>objc_object<span class="token operator">&gt;</span><span class="token punctuation">,</span> ObjectAssociationMap<span class="token operator">&gt;</span> AssociationsHashMap<span class="token punctuation">;</span>

<span class="token comment">// class AssociationsManager manages a lock / hash table singleton pair.</span>
<span class="token comment">// Allocating an instance acquires the lock</span>

class AssociationsManager <span class="token punctuation">{</span>
    using Storage <span class="token operator">=</span> ExplicitInitDenseMap<span class="token operator">&lt;</span>DisguisedPtr<span class="token operator">&lt;</span>objc_object<span class="token operator">&gt;</span><span class="token punctuation">,</span> ObjectAssociationMap<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> Storage _mapStorage<span class="token punctuation">;</span>

public<span class="token operator">:</span>
    <span class="token function">AssociationsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span> AssociationsManagerLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">AssociationsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> AssociationsManagerLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    AssociationsHashMap <span class="token operator">&amp;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _mapStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _mapStorage<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>其实就是管理了一个static的哈希表，以object对象指针为key，value为<code>ObjectAssociationMap</code>，map保存着的key和<code>ObjcAssociation</code>对象，而<code>ObjcAssociation</code>就是value和<code>objc_AssociationPolicy</code>。</p> <p>对象销毁逻辑，代码如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/***********************************************************************
* objc_destructInstance
* Destroys an instance without freeing memory. 
* Calls C++ destructors.
* Calls ARC ivar cleanup.
* Removes associative references.
* Returns `obj`. Does nothing if `obj` is nil.
**********************************************************************/</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">objc_destructInstance</span><span class="token punctuation">(</span>id obj<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Read all of the flags at once for performance.</span>
        bool cxx <span class="token operator">=</span> obj<span class="token operator">-&gt;</span><span class="token function">hasCxxDtor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bool assoc <span class="token operator">=</span> obj<span class="token operator">-&gt;</span><span class="token function">hasAssociatedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// This order is important.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cxx<span class="token punctuation">)</span> <span class="token function">object_cxxDestruct</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>assoc<span class="token punctuation">)</span> <span class="token function">_object_remove_assocations</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token comment">/*deallocating*/</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token operator">-&gt;</span><span class="token function">clearDeallocating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>runtime销毁对象函数时会判断是否有关联对象，如果有，调用<code>_object_remove_assocations</code>移除关联对象</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/26/2022, 7:43:01 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/ios/basic/oc/notification.html" class="prev">
            NSNotification
          </a></span> <span class="next"><a href="/ios/basic/oc/load-initialize.html">
            Load和Initialize
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/ios/basic/oc/category-extension.html#extension" class="sidebar-link reco-side-extension" data-v-70334359>Extension</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/oc/category-extension.html#category" class="sidebar-link reco-side-category" data-v-70334359>Category</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/category-extension.html#category结构分析" class="sidebar-link reco-side-category结构分析" data-v-70334359>Category结构分析</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/category-extension.html#category加载过程" class="sidebar-link reco-side-category加载过程" data-v-70334359>Category加载过程</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/category-extension.html#category和-load方法" class="sidebar-link reco-side-category和-load方法" data-v-70334359>Category和+load方法</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/category-extension.html#category和方法覆盖" class="sidebar-link reco-side-category和方法覆盖" data-v-70334359>Category和方法覆盖</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/oc/category-extension.html#category和关联对象" class="sidebar-link reco-side-category和关联对象" data-v-70334359>Category和关联对象</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.089bdbaa.js" defer></script><script src="/assets/js/4.8c49e3da.js" defer></script><script src="/assets/js/1.020c262d.js" defer></script><script src="/assets/js/86.4e70842d.js" defer></script><script src="/assets/js/14.89e438f3.js" defer></script>
  </body>
</html>
