<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>锁 | 坤坤同学</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="关心你所关心的，与世界分享你的知识、经验和见闻">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.91675566.css" as="style"><link rel="preload" href="/assets/js/app.86aa6019.js" as="script"><link rel="preload" href="/assets/js/4.10069921.js" as="script"><link rel="preload" href="/assets/js/1.c288e991.js" as="script"><link rel="preload" href="/assets/js/68.2023979f.js" as="script"><link rel="preload" href="/assets/js/9.1417a78f.js" as="script"><link rel="prefetch" href="/assets/js/10.3ed9434f.js"><link rel="prefetch" href="/assets/js/100.fa901c4d.js"><link rel="prefetch" href="/assets/js/101.cdd053cd.js"><link rel="prefetch" href="/assets/js/102.0251f401.js"><link rel="prefetch" href="/assets/js/11.a6693458.js"><link rel="prefetch" href="/assets/js/12.2e880116.js"><link rel="prefetch" href="/assets/js/13.80335f39.js"><link rel="prefetch" href="/assets/js/14.ffd894ca.js"><link rel="prefetch" href="/assets/js/15.89531ed0.js"><link rel="prefetch" href="/assets/js/16.e7942625.js"><link rel="prefetch" href="/assets/js/17.6f30b859.js"><link rel="prefetch" href="/assets/js/18.eb9c8310.js"><link rel="prefetch" href="/assets/js/19.e9353a96.js"><link rel="prefetch" href="/assets/js/20.20996294.js"><link rel="prefetch" href="/assets/js/21.a28ca72c.js"><link rel="prefetch" href="/assets/js/22.6ef7b6a2.js"><link rel="prefetch" href="/assets/js/23.c0313df7.js"><link rel="prefetch" href="/assets/js/24.773abc82.js"><link rel="prefetch" href="/assets/js/25.b4e9e073.js"><link rel="prefetch" href="/assets/js/26.fed5348c.js"><link rel="prefetch" href="/assets/js/27.35ccc14b.js"><link rel="prefetch" href="/assets/js/28.5b59b539.js"><link rel="prefetch" href="/assets/js/29.033a2429.js"><link rel="prefetch" href="/assets/js/30.8c56543c.js"><link rel="prefetch" href="/assets/js/31.0a8a1d80.js"><link rel="prefetch" href="/assets/js/32.9784b164.js"><link rel="prefetch" href="/assets/js/33.9c36cd77.js"><link rel="prefetch" href="/assets/js/34.55a29e37.js"><link rel="prefetch" href="/assets/js/35.a00d6970.js"><link rel="prefetch" href="/assets/js/36.f7f96931.js"><link rel="prefetch" href="/assets/js/37.1c140229.js"><link rel="prefetch" href="/assets/js/38.e19d1e55.js"><link rel="prefetch" href="/assets/js/39.85ea9a14.js"><link rel="prefetch" href="/assets/js/40.410f9a63.js"><link rel="prefetch" href="/assets/js/41.a2193986.js"><link rel="prefetch" href="/assets/js/42.212bc6a4.js"><link rel="prefetch" href="/assets/js/43.9d4ec479.js"><link rel="prefetch" href="/assets/js/44.bbe4e5de.js"><link rel="prefetch" href="/assets/js/45.5e8dca7b.js"><link rel="prefetch" href="/assets/js/46.0d726ab7.js"><link rel="prefetch" href="/assets/js/47.399e34db.js"><link rel="prefetch" href="/assets/js/48.a3036e65.js"><link rel="prefetch" href="/assets/js/49.899c50a1.js"><link rel="prefetch" href="/assets/js/5.da3929a7.js"><link rel="prefetch" href="/assets/js/50.2a6aef37.js"><link rel="prefetch" href="/assets/js/51.77de6b86.js"><link rel="prefetch" href="/assets/js/52.34430815.js"><link rel="prefetch" href="/assets/js/53.e298b416.js"><link rel="prefetch" href="/assets/js/54.a0638887.js"><link rel="prefetch" href="/assets/js/55.21517304.js"><link rel="prefetch" href="/assets/js/56.8f2ebec8.js"><link rel="prefetch" href="/assets/js/57.cab99a32.js"><link rel="prefetch" href="/assets/js/58.63d246a9.js"><link rel="prefetch" href="/assets/js/59.4277086c.js"><link rel="prefetch" href="/assets/js/6.e39f5ca0.js"><link rel="prefetch" href="/assets/js/60.bc333cb8.js"><link rel="prefetch" href="/assets/js/61.5a424c7f.js"><link rel="prefetch" href="/assets/js/62.7adc686f.js"><link rel="prefetch" href="/assets/js/63.c50face7.js"><link rel="prefetch" href="/assets/js/64.3ab22c7d.js"><link rel="prefetch" href="/assets/js/65.49a77af0.js"><link rel="prefetch" href="/assets/js/66.f74b86c1.js"><link rel="prefetch" href="/assets/js/67.a7794b45.js"><link rel="prefetch" href="/assets/js/69.8c7721ee.js"><link rel="prefetch" href="/assets/js/7.694cc372.js"><link rel="prefetch" href="/assets/js/70.c837a105.js"><link rel="prefetch" href="/assets/js/71.593a8163.js"><link rel="prefetch" href="/assets/js/72.c145565e.js"><link rel="prefetch" href="/assets/js/73.6c284ed8.js"><link rel="prefetch" href="/assets/js/74.713d03f3.js"><link rel="prefetch" href="/assets/js/75.3091dd08.js"><link rel="prefetch" href="/assets/js/76.d5eecf1b.js"><link rel="prefetch" href="/assets/js/77.68b537f6.js"><link rel="prefetch" href="/assets/js/78.7f26a50c.js"><link rel="prefetch" href="/assets/js/79.4cab3279.js"><link rel="prefetch" href="/assets/js/8.762d7cfc.js"><link rel="prefetch" href="/assets/js/80.764c4018.js"><link rel="prefetch" href="/assets/js/81.cfdf726f.js"><link rel="prefetch" href="/assets/js/82.89fe1b6b.js"><link rel="prefetch" href="/assets/js/83.9b7cde73.js"><link rel="prefetch" href="/assets/js/84.cb9f1c8c.js"><link rel="prefetch" href="/assets/js/85.9f01ab26.js"><link rel="prefetch" href="/assets/js/86.89bcd1da.js"><link rel="prefetch" href="/assets/js/87.cb854294.js"><link rel="prefetch" href="/assets/js/88.c93205c6.js"><link rel="prefetch" href="/assets/js/89.710cd1f3.js"><link rel="prefetch" href="/assets/js/90.6271fd01.js"><link rel="prefetch" href="/assets/js/91.2ebfb8a1.js"><link rel="prefetch" href="/assets/js/92.b736829a.js"><link rel="prefetch" href="/assets/js/93.f3de7541.js"><link rel="prefetch" href="/assets/js/94.11400c8d.js"><link rel="prefetch" href="/assets/js/95.c5edf39a.js"><link rel="prefetch" href="/assets/js/96.c92647a6.js"><link rel="prefetch" href="/assets/js/97.599e7f06.js"><link rel="prefetch" href="/assets/js/98.826272d9.js"><link rel="prefetch" href="/assets/js/99.67d131b1.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.254f7798.js">
    <link rel="stylesheet" href="/assets/css/0.styles.91675566.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>坤坤同学</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>关心你所关心的，与世界分享你的知识、经验和见闻</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="坤坤同学" class="logo"> <span class="site-name">坤坤同学</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    wanyakun
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>36</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>3</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/ios/" aria-current="page" class="sidebar-link">关于</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目经验</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三方库原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>提问</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>锁</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">锁</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>wanyakun</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>12/19/2022</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h2> <h3 id="互斥锁"><a href="#互斥锁" class="header-anchor">#</a> 互斥锁</h3> <p>属于sleep-waiting类型的锁，线程A获取到锁，在释放锁之前，其他线程都获取不到锁。互斥锁也分为两种：</p> <ul><li>递归锁：可重入锁，同一个线程在锁释放前可再次获取锁，即可以递归调用</li> <li>非递归锁：不可重入，必须等锁释放后才能再次获取锁</li></ul> <h3 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h3> <p>线程A获取到锁，在释放锁之前，线程B又来获取锁，此时获取不到，线程B就会不断的进入循环，一直检查锁是否已被释放，如果释放，则能获取到锁。</p> <h3 id="区别"><a href="#区别" class="header-anchor">#</a> 区别</h3> <p>互斥锁：当线程获取锁但没有获取到时，线程会进入休眠状态，等锁被释放时，线程会被唤醒，同时获取到锁，继续执行任务，互斥锁会改变线程的状态。线程从sleep（加锁）—&gt;running（解锁）的过程中，有上下文的切换，cpu的抢占，信号的发送等开销。<br>
自旋锁：当线程获取锁但没获取到时，不会进入休眠，而是一直循环，线程始终处于活跃状态，不会改变线程状态，也就是忙等。线程一直是running(加锁—&gt;解锁)，死循环检测锁的标志位。递归调用自旋锁一定会死锁。</p> <p>互斥锁的起始原始开销要高于自旋锁，但是基本是一劳永逸，临界区持锁时间的大小并不会对互斥锁的开销造成影响，而自旋锁是死循环检测，加锁全程消耗cpu，起始开销虽然低于互斥锁，但是随着持锁时间，加锁的开销是线性增长</p> <h3 id="适用场景"><a href="#适用场景" class="header-anchor">#</a> 适用场景</h3> <p>互斥锁会改变线程的状态，使得内核不断的调度线程资源，因此效率上比自旋锁要低很多，不适合使用自旋锁的场景都使用互斥锁。<br>
自旋锁在线程的等待过程中是活跃的，避免了进程上下文的调度开销，因此对于线程只会阻塞很短时间的场合是有效的。因此自旋锁适合用于短时间内的轻量级锁定，主要用在临界区持锁时间非常短且CPU资源不紧张的情况下。</p> <h2 id="常见锁"><a href="#常见锁" class="header-anchor">#</a> 常见锁</h2> <h3 id="nslock"><a href="#nslock" class="header-anchor">#</a> NSLock</h3> <p>NSLock是Cocoa提供给我们最基本的锁对象，也是我们经常使用的，除了lock和unlock方法外，还提供了tryLock和lockBeforeDate：两个方法，前一个方法会尝试加锁，如果锁不可用（已经被锁住了），并不会阻塞线程，直接返回NO。lockBeforeDate方法会在指定Date之前尝试加锁，如果在指定时间之前都不能加锁，则返回NO</p> <h3 id="synchronized"><a href="#synchronized" class="header-anchor">#</a> @synchronized</h3> <p>@synchronized指令使用参数对象为该段唯一标示，只有当标示相同时，才满足互斥。<br>
@synchronized指令实现锁的优点就是我们不需要在代码中显式的创建锁对象，便可以实现锁的机制。但作为一种预防措施，@synchronized块会隐式的添加一个异常处理例程来保护代码，该处理例程会在异常抛出的时候自动的释放互斥锁。所以如果不想让隐式的异常处理例程带来额外的开销，可以考虑使用锁对象</p> <h3 id="pthread-mutex-t"><a href="#pthread-mutex-t" class="header-anchor">#</a> pthread_mutex_t</h3> <p>c语音实现，在pthread.h头文件中，mutex叫做”互斥锁”，等待锁的线程会处于休眠状态</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>pthread_mutex_t lock<span class="token punctuation">;</span>
<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="os-unfair-lock"><a href="#os-unfair-lock" class="header-anchor">#</a> os_unfair_lock</h3> <p>苹果官方推荐的替换OSSpinLock的方案，但是它在iOS10.0以上的系统才可以调用。os_unfair_lock是一种互斥锁，它不会向自旋锁那样忙等，而是等待线程会休眠。</p> <h3 id="osspinklock"><a href="#osspinklock" class="header-anchor">#</a> OSSPinkLock</h3> <p>自旋锁，忙等。</p> <p>也正是由于它是自旋锁，所以容易发生优先级反转的问题。<br>
当一个低优先级线程获得锁的时候，如果此时一个高优先级的系统到来，那么会进入忙等状态，不会进入睡眠，此时会一直占用着系统CPU时间，导致低优先级的无法拿到CPU时间片，从而无法完成任务也无法释放锁。除非能保证访问锁的线程全部处于同一优先级，否则系统所有的自旋锁都会出现优先级反转的问题</p> <h3 id="pthread-rwlock"><a href="#pthread-rwlock" class="header-anchor">#</a> pthread_rwlock</h3> <p>读写锁</p> <p>读写锁实际是一种特殊的自旋锁，它把对共享资源的访问者划分成读者和写者，读者只对共享资源进行读访问，写者则需要对共享资源进行写操作。这种锁相对于自旋锁而言，能提高并发性，因为 在多处理器系统中，它允许同时有多个读者来访问共享资源，最大可能的读者数为实际的逻辑CPU数。写者是排他性的，一个读写锁同时只能有一个写者或多个读者(与CPU数相关)，但不能同时既有读者又有写者。在读写锁保持期间也是抢占失效的。<br>
一次只有一个线程可以占有写模式的读写锁, 但是可以有多个线程同时占有读模式的读写锁。正是因为这个特性pthread_rwlock 适合于对数据结构的读次数比写次数多得多的情况。因为, 读模式锁定时可以共享, 以写模式锁住时意味着独占, 所以读写锁又叫共享-独占锁。</p> <h3 id="nsrecuresivelock"><a href="#nsrecuresivelock" class="header-anchor">#</a> NSRecuresiveLock</h3> <p>递归锁。平常我们在代码中使用锁的时候，最容易犯的一个错误就是造成死锁，而容易造成死锁的一种情形就是在递归或循环中。在递归或者循环代码中使用锁容易造成死锁，可以将NSLock换成NSRecursiveLock，pthread_mutex_t设置atrr。</p> <p>NSRecursiveLock类定义的锁可以在同一线程中多次lock，而不会造成死锁。递归锁会跟踪它被多少次lock，每次成功的lock都必须调用平衡调用unlock操作。只有所有的锁住和解锁操作都平衡的时候，锁才真正被释放给其他线程获得。</p> <h3 id="pthread-mutex-t-recuresive"><a href="#pthread-mutex-t-recuresive" class="header-anchor">#</a> pthread_mutex_t(recuresive)</h3> <p>也支持递归，只需要设置PTHREAD_MUTEX_RECURSIVE即可</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>pthread_mutex_t lock<span class="token punctuation">;</span> 
pthread_mutexattr_t attr<span class="token punctuation">;</span> 
<span class="token function">pthread_mutexattr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">pthread_mutexattr_settype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> PTHREAD_MUTEX_RECURSIVE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">pthread_mutexattr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="nscondition"><a href="#nscondition" class="header-anchor">#</a> NSCondition</h3> <p>条件锁，遵循NSLocking协议，使用的时候同样是lock,unlock加解锁，wait是傻等，waitUntilDate:方法是等一会，都会阻塞掉线程，signal是唤起一个在等待的线程，broadcast是广播全部唤起。</p> <h3 id="nsconditonlock"><a href="#nsconditonlock" class="header-anchor">#</a> NSConditonLock</h3> <p>条件锁，NSConditionLock也跟其他的锁一样，需要lock和unlock对应的，只是lock、lockWhenCondition: 与unlock、unlockWithCondition: 是可以随意组合的。</p> <h3 id="dispatch-semaphore"><a href="#dispatch-semaphore" class="header-anchor">#</a> dispatch_semaphore</h3> <p>信号量，一般情况下，访问性能比NSMutableArray低，但比使用@synchronize、NSLock、pthread_mutex_t高</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>dispatch_semaphore_t semaphore <span class="token operator">=</span> <span class="token function">dispatch_semaphore_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispatch_semaphore_wait</span><span class="token punctuation">(</span>semaphore<span class="token punctuation">,</span> DISPATCH_TIME_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispatch_semaphore_signal</span><span class="token punctuation">(</span>semaphore<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>只要信号量的value大于0，其他线程就可以sem_wait成功，成功后信号量的value减一。若value值不大于0，则sem_wait阻塞，直到sem_post释放后value值加一。<br>
一句话value&gt;=0</p> <h3 id="nsdistributedlock"><a href="#nsdistributedlock" class="header-anchor">#</a> NSDistributedLock</h3> <p>分布式锁，macOS中的，用于多个进程或者多个程序之间需要构建互斥的情况。NSDistributedLock的实现是通过文件系统的，所以它可以有效的实现不同进程之间的互斥。</p> <h3 id="atomic"><a href="#atomic" class="header-anchor">#</a> atomic</h3> <p>atomic用于保证属性setter、getter的原子性操作，相当于在getter和setter内部加了线程同步的锁。并不能保证使用属性的过程是线程安全的。</p> <p>getter和setter中使用了spinlock_t</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldValue <span class="token operator">=</span> <span class="token operator">*</span>slot<span class="token punctuation">;</span>
    <span class="token operator">*</span>slot <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    spinlock_t<span class="token operator">&amp;</span> slotlock <span class="token operator">=</span> PropertyLocks<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
    slotlock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oldValue <span class="token operator">=</span> <span class="token operator">*</span>slot<span class="token punctuation">;</span>
    <span class="token operator">*</span>slot <span class="token operator">=</span> newValue<span class="token punctuation">;</span>        
    slotlock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Atomic retain release world</span>
spinlock_t<span class="token operator">&amp;</span> slotlock <span class="token operator">=</span> PropertyLocks<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
slotlock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
id value <span class="token operator">=</span> <span class="token function">objc_retain</span><span class="token punctuation">(</span><span class="token operator">*</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
slotlock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>而spinlock_t内部使用的是os_unfair_lock</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>using spinlock_t <span class="token operator">=</span> mutex_tt<span class="token operator">&lt;</span>LOCKDEBUG<span class="token operator">&gt;</span><span class="token punctuation">;</span>

template <span class="token operator">&lt;</span>bool Debug<span class="token operator">&gt;</span>
class mutex_tt <span class="token punctuation">:</span> nocopy_t <span class="token punctuation">{</span>
  os_unfair_lock mLock<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lockdebug_mutex_lock</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &lt;rdar://problem/50384154&gt;</span>
    uint32_t opts <span class="token operator">=</span> OS_UNFAIR_LOCK_DATA_SYNCHRONIZATION <span class="token operator">|</span> OS_UNFAIR_LOCK_ADAPTIVE_SPIN<span class="token punctuation">;</span>
    <span class="token function">os_unfair_lock_lock_with_options_inline</span>
        <span class="token punctuation">(</span><span class="token operator">&amp;</span>mLock<span class="token punctuation">,</span> <span class="token punctuation">(</span>os_unfair_lock_options_t<span class="token punctuation">)</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lockdebug_mutex_unlock</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">os_unfair_lock_unlock_inline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="性能-从高到低"><a href="#性能-从高到低" class="header-anchor">#</a> 性能（从高到低）</h2> <ul><li>os_unfair_lock</li> <li>OSSpinLock</li> <li>dispatch_semaphore</li> <li>pthread_mutex_t(default)</li> <li>NSLock</li> <li>NSCondition</li> <li>pthread_mutex_t(recursive)</li> <li>NSRecursiveLock</li> <li>NSConditionLock</li> <li>@synchronized</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/23/2022, 5:52:31 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/ios/basic/multithread/gcd.html" class="prev">
            GCD
          </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/ios/basic/multithread/lock.html#分类" class="sidebar-link reco-side-分类" data-v-70334359>分类</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#互斥锁" class="sidebar-link reco-side-互斥锁" data-v-70334359>互斥锁</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#自旋锁" class="sidebar-link reco-side-自旋锁" data-v-70334359>自旋锁</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#区别" class="sidebar-link reco-side-区别" data-v-70334359>区别</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#适用场景" class="sidebar-link reco-side-适用场景" data-v-70334359>适用场景</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/multithread/lock.html#常见锁" class="sidebar-link reco-side-常见锁" data-v-70334359>常见锁</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#nslock" class="sidebar-link reco-side-nslock" data-v-70334359>NSLock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#synchronized" class="sidebar-link reco-side-synchronized" data-v-70334359>@synchronized</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#pthread-mutex-t" class="sidebar-link reco-side-pthread-mutex-t" data-v-70334359>pthreadmutext</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#os-unfair-lock" class="sidebar-link reco-side-os-unfair-lock" data-v-70334359>osunfairlock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#osspinklock" class="sidebar-link reco-side-osspinklock" data-v-70334359>OSSPinkLock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#pthread-rwlock" class="sidebar-link reco-side-pthread-rwlock" data-v-70334359>pthread_rwlock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#nsrecuresivelock" class="sidebar-link reco-side-nsrecuresivelock" data-v-70334359>NSRecuresiveLock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#pthread-mutex-t-recuresive" class="sidebar-link reco-side-pthread-mutex-t-recuresive" data-v-70334359>pthreadmutext(recuresive)</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#nscondition" class="sidebar-link reco-side-nscondition" data-v-70334359>NSCondition</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#nsconditonlock" class="sidebar-link reco-side-nsconditonlock" data-v-70334359>NSConditonLock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#dispatch-semaphore" class="sidebar-link reco-side-dispatch-semaphore" data-v-70334359>dispatch_semaphore</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#nsdistributedlock" class="sidebar-link reco-side-nsdistributedlock" data-v-70334359>NSDistributedLock</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/multithread/lock.html#atomic" class="sidebar-link reco-side-atomic" data-v-70334359>atomic</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/multithread/lock.html#性能-从高到低" class="sidebar-link reco-side-性能-从高到低" data-v-70334359>性能（从高到低）</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.86aa6019.js" defer></script><script src="/assets/js/4.10069921.js" defer></script><script src="/assets/js/1.c288e991.js" defer></script><script src="/assets/js/68.2023979f.js" defer></script><script src="/assets/js/9.1417a78f.js" defer></script>
  </body>
</html>
