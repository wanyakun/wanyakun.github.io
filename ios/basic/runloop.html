<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RunLoop | 坤坤同学</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="关心你所关心的，与世界分享你的知识、经验和见闻">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.919d61a7.css" as="style"><link rel="preload" href="/assets/js/app.e1d9a5d5.js" as="script"><link rel="preload" href="/assets/js/4.c013567b.js" as="script"><link rel="preload" href="/assets/js/1.9dc3b061.js" as="script"><link rel="preload" href="/assets/js/100.7e99e635.js" as="script"><link rel="preload" href="/assets/js/14.ec05e296.js" as="script"><link rel="prefetch" href="/assets/js/10.2fd75826.js"><link rel="prefetch" href="/assets/js/101.afb28f76.js"><link rel="prefetch" href="/assets/js/102.8f861b88.js"><link rel="prefetch" href="/assets/js/103.de69bd60.js"><link rel="prefetch" href="/assets/js/104.f45b50d7.js"><link rel="prefetch" href="/assets/js/105.3a79f61a.js"><link rel="prefetch" href="/assets/js/106.c64c28d4.js"><link rel="prefetch" href="/assets/js/107.ad598e6e.js"><link rel="prefetch" href="/assets/js/108.267a56f9.js"><link rel="prefetch" href="/assets/js/109.4e5f7c33.js"><link rel="prefetch" href="/assets/js/11.1c7f0b0d.js"><link rel="prefetch" href="/assets/js/110.2db18860.js"><link rel="prefetch" href="/assets/js/111.8f14f5a0.js"><link rel="prefetch" href="/assets/js/112.59653e9d.js"><link rel="prefetch" href="/assets/js/113.10e4830d.js"><link rel="prefetch" href="/assets/js/114.36dc444c.js"><link rel="prefetch" href="/assets/js/115.10f9e142.js"><link rel="prefetch" href="/assets/js/116.32659919.js"><link rel="prefetch" href="/assets/js/117.88d0117d.js"><link rel="prefetch" href="/assets/js/118.20e0bc44.js"><link rel="prefetch" href="/assets/js/119.99c284a5.js"><link rel="prefetch" href="/assets/js/12.0676a802.js"><link rel="prefetch" href="/assets/js/120.13ae68c7.js"><link rel="prefetch" href="/assets/js/121.e59593fe.js"><link rel="prefetch" href="/assets/js/122.89ba845a.js"><link rel="prefetch" href="/assets/js/123.9e6ea79d.js"><link rel="prefetch" href="/assets/js/124.1449acea.js"><link rel="prefetch" href="/assets/js/13.b558ab90.js"><link rel="prefetch" href="/assets/js/15.85cd93d5.js"><link rel="prefetch" href="/assets/js/16.26725829.js"><link rel="prefetch" href="/assets/js/17.6ab1cc88.js"><link rel="prefetch" href="/assets/js/18.5f1529d2.js"><link rel="prefetch" href="/assets/js/19.93cfd98c.js"><link rel="prefetch" href="/assets/js/20.0f883707.js"><link rel="prefetch" href="/assets/js/21.1c6d7b3b.js"><link rel="prefetch" href="/assets/js/22.2578695c.js"><link rel="prefetch" href="/assets/js/23.ce6495af.js"><link rel="prefetch" href="/assets/js/24.88273ac1.js"><link rel="prefetch" href="/assets/js/25.1925dd52.js"><link rel="prefetch" href="/assets/js/26.9e4e8c3d.js"><link rel="prefetch" href="/assets/js/27.2c9b45ce.js"><link rel="prefetch" href="/assets/js/28.1f6833df.js"><link rel="prefetch" href="/assets/js/29.059e0abf.js"><link rel="prefetch" href="/assets/js/30.d2732855.js"><link rel="prefetch" href="/assets/js/31.a1608fb8.js"><link rel="prefetch" href="/assets/js/32.25ecda77.js"><link rel="prefetch" href="/assets/js/33.3587dfbc.js"><link rel="prefetch" href="/assets/js/34.c25a1993.js"><link rel="prefetch" href="/assets/js/35.b7499689.js"><link rel="prefetch" href="/assets/js/36.66be4a29.js"><link rel="prefetch" href="/assets/js/37.87d1d6fa.js"><link rel="prefetch" href="/assets/js/38.8acaf4cb.js"><link rel="prefetch" href="/assets/js/39.9a5f8ea6.js"><link rel="prefetch" href="/assets/js/40.6243af45.js"><link rel="prefetch" href="/assets/js/41.1c32f9be.js"><link rel="prefetch" href="/assets/js/42.1be9ddf2.js"><link rel="prefetch" href="/assets/js/43.0b82843a.js"><link rel="prefetch" href="/assets/js/44.c950d3ed.js"><link rel="prefetch" href="/assets/js/45.5b972527.js"><link rel="prefetch" href="/assets/js/46.9df474ab.js"><link rel="prefetch" href="/assets/js/47.a8098956.js"><link rel="prefetch" href="/assets/js/48.2aa774e6.js"><link rel="prefetch" href="/assets/js/49.bd5b76ae.js"><link rel="prefetch" href="/assets/js/5.4441c32a.js"><link rel="prefetch" href="/assets/js/50.81c1e03e.js"><link rel="prefetch" href="/assets/js/51.2a5708bf.js"><link rel="prefetch" href="/assets/js/52.f900a0d2.js"><link rel="prefetch" href="/assets/js/53.8a5b75c3.js"><link rel="prefetch" href="/assets/js/54.8a30a936.js"><link rel="prefetch" href="/assets/js/55.1f485d9d.js"><link rel="prefetch" href="/assets/js/56.0adc32c2.js"><link rel="prefetch" href="/assets/js/57.4c938e7f.js"><link rel="prefetch" href="/assets/js/58.ebd5563d.js"><link rel="prefetch" href="/assets/js/59.488db284.js"><link rel="prefetch" href="/assets/js/6.de6a74d0.js"><link rel="prefetch" href="/assets/js/60.745fb040.js"><link rel="prefetch" href="/assets/js/61.6bee1dd0.js"><link rel="prefetch" href="/assets/js/62.8b625a07.js"><link rel="prefetch" href="/assets/js/63.98d7a41f.js"><link rel="prefetch" href="/assets/js/64.eeaa59fb.js"><link rel="prefetch" href="/assets/js/65.e3ea351e.js"><link rel="prefetch" href="/assets/js/66.41544cc8.js"><link rel="prefetch" href="/assets/js/67.74187466.js"><link rel="prefetch" href="/assets/js/68.eacfd2eb.js"><link rel="prefetch" href="/assets/js/69.cb3e7a3f.js"><link rel="prefetch" href="/assets/js/7.ba6c20d7.js"><link rel="prefetch" href="/assets/js/70.b40d218e.js"><link rel="prefetch" href="/assets/js/71.72176f57.js"><link rel="prefetch" href="/assets/js/72.f8815609.js"><link rel="prefetch" href="/assets/js/73.6fbe8888.js"><link rel="prefetch" href="/assets/js/74.4a3c276d.js"><link rel="prefetch" href="/assets/js/75.586b003b.js"><link rel="prefetch" href="/assets/js/76.ef0ec8f8.js"><link rel="prefetch" href="/assets/js/77.63b16edb.js"><link rel="prefetch" href="/assets/js/78.0cfffec9.js"><link rel="prefetch" href="/assets/js/79.645cea5c.js"><link rel="prefetch" href="/assets/js/8.1e60c6b7.js"><link rel="prefetch" href="/assets/js/80.03daf244.js"><link rel="prefetch" href="/assets/js/81.c311bdf2.js"><link rel="prefetch" href="/assets/js/82.fabe63b6.js"><link rel="prefetch" href="/assets/js/83.6ab06180.js"><link rel="prefetch" href="/assets/js/84.958c977a.js"><link rel="prefetch" href="/assets/js/85.a261c03e.js"><link rel="prefetch" href="/assets/js/86.190cf14f.js"><link rel="prefetch" href="/assets/js/87.1c94679b.js"><link rel="prefetch" href="/assets/js/88.8146a7fc.js"><link rel="prefetch" href="/assets/js/89.33d448b3.js"><link rel="prefetch" href="/assets/js/9.0cc304c7.js"><link rel="prefetch" href="/assets/js/90.4f29d8c3.js"><link rel="prefetch" href="/assets/js/91.42a040dd.js"><link rel="prefetch" href="/assets/js/92.0bedd033.js"><link rel="prefetch" href="/assets/js/93.fe0c07e6.js"><link rel="prefetch" href="/assets/js/94.356f289f.js"><link rel="prefetch" href="/assets/js/95.70144fc0.js"><link rel="prefetch" href="/assets/js/96.7fa3d406.js"><link rel="prefetch" href="/assets/js/97.6812c585.js"><link rel="prefetch" href="/assets/js/98.b58b6a3f.js"><link rel="prefetch" href="/assets/js/99.b6926535.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.9bdcec82.js">
    <link rel="stylesheet" href="/assets/css/0.styles.919d61a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>坤坤同学</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>关心你所关心的，与世界分享你的知识、经验和见闻</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="坤坤同学" class="logo"> <span class="site-name">坤坤同学</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    wanyakun
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>36</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>3</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/iOS/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/3D/" class="nav-link"><i class="undefined"></i>
  3D
</a></li><li class="dropdown-item"><!----> <a href="/categories/Summary/" class="nav-link"><i class="undefined"></i>
  Summary
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/ios/" class="nav-link router-link-active"><i class="iconfont reco-other"></i>
  iOS
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="iconfont reco-npm"></i>
  前端
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-document"></i>
  Notes
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wanyakun" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/ios/" aria-current="page" class="sidebar-link">关于</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>基础知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Objective-C</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ios/basic/oc/block.html" class="sidebar-link">Block</a></li><li><a href="/ios/basic/oc/kvo.html" class="sidebar-link">KVO</a></li><li><a href="/ios/basic/oc/kvc.html" class="sidebar-link">KVC</a></li><li><a href="/ios/basic/oc/notification.html" class="sidebar-link">NSNotification</a></li><li><a href="/ios/basic/oc/category-extension.html" class="sidebar-link">Category和Extension</a></li><li><a href="/ios/basic/oc/load-initialize.html" class="sidebar-link">Load和Initialize</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Swift</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>UI</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/ios/basic/memory.html" class="sidebar-link">内存管理</a></li><li><a href="/ios/basic/runtime.html" class="sidebar-link">Runtime</a></li><li><a href="/ios/basic/runloop.html" aria-current="page" class="active sidebar-link">RunLoop</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>多线程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目经验</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三方库原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>提问</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>RunLoop</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>wanyakun</span>
            
          <span data-v-4e82dffc>2016 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">RunLoop</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>wanyakun</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>5/19/2021</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="runloop是什么"><a href="#runloop是什么" class="header-anchor">#</a> RunLoop是什么</h2> <p>从代码上看，RunLoop其实就是一个对象，它的结构如下</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">struct</span> __CFRunLoop <span class="token punctuation">{</span>
    CFRuntimeBase _base<span class="token punctuation">;</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>			<span class="token comment">/* locked for accessing mode list */</span>
    __CFPort _wakeUpPort<span class="token punctuation">;</span>			<span class="token comment">// used for CFRunLoopWakeUp 内核向该端口发送消息可以唤醒runloop</span>
    Boolean _unused<span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> _per_run_data <span class="token operator">*</span>_perRunData<span class="token punctuation">;</span>              <span class="token comment">// reset for runs of the run loop</span>
    pthread_t _pthread<span class="token punctuation">;</span>     <span class="token comment">//RunLoop对应的线程</span>
    uint32_t _winthread<span class="token punctuation">;</span>
    CFMutableSetRef _commonModes<span class="token punctuation">;</span>       <span class="token comment">//存储的是字符串，记录所有标记为common的mode</span>
    CFMutableSetRef _commonModeItems<span class="token punctuation">;</span>   <span class="token comment">//存储所有commonMode的item(source、timer、observer)</span>
    CFRunLoopModeRef _currentMode<span class="token punctuation">;</span>      <span class="token comment">//当前运行的mode</span>
    CFMutableSetRef _modes<span class="token punctuation">;</span>             <span class="token comment">//存储的是CFRunLoopModeRef</span>
    <span class="token keyword">struct</span> _block_item <span class="token operator">*</span>_blocks_head<span class="token punctuation">;</span>   <span class="token comment">//doblocks的时候用到</span>
    <span class="token keyword">struct</span> _block_item <span class="token operator">*</span>_blocks_tail<span class="token punctuation">;</span>
    CFAbsoluteTime _runTime<span class="token punctuation">;</span>
    CFAbsoluteTime _sleepTime<span class="token punctuation">;</span>
    CFTypeRef _counterpart<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可见，一个RunLoop对象，主要包含了一个线程，若干个Mode，若干个commonMode，还有一个当前运行的Mode。</p> <h2 id="runloop作用"><a href="#runloop作用" class="header-anchor">#</a> Runloop作用</h2> <p>Runloop用来监控任务的输入源，并在输入源准备就绪后，对其进行调度控制，常见的输入源包括：用户输入设备、网络链接、时钟、延迟触发事件、异步回调等等。输入源分为三类：</p> <ol><li>Sources：触发事件是外部消息（信号）</li> <li>Timers：触发事件是时钟信号</li> <li>Observers： 触发事件是Runloop状态变更</li></ol> <p>它们有回调函数，Runloop接收到某输入源的触发事件时，会执行该输入源的回调函数。监控输入源之前，需要创建一个observer将其添加到Runloop中，不再需要监控时，则将其从Runloop中移除，回调函数就不再触发。<br>
注意：runloop调用输入源的回调函数时同步调用，而不是异步，也就说如果回调函数的处理过程如果特别耗时，会直接影响到其他输入源事件的响应的实效性。</p> <h2 id="runloop和线程的关系"><a href="#runloop和线程的关系" class="header-anchor">#</a> RunLoop和线程的关系</h2> <ol><li>线程和Runloop之间是一一对应的，其关系保存在一个全局的Dictionary里，</li> <li>线程刚创建时并没有Runloop，如果不主动获取，它一直都不会有</li> <li>Runloop的创建发生在第一次获取时，Runloop的销毁发生在线程结束时。</li> <li>只能在一个线程内部获取其Runloop（主线程除外）</li></ol> <h2 id="runloop-mode"><a href="#runloop-mode" class="header-anchor">#</a> RunLoop Mode</h2> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">struct</span> __CFRunLoopMode <span class="token punctuation">{</span>
    CFRuntimeBase _base<span class="token punctuation">;</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>	<span class="token comment">/* must have the run loop locked before locking this */</span>
    CFStringRef _name<span class="token punctuation">;</span>      <span class="token comment">//mode名称</span>
    Boolean _stopped<span class="token punctuation">;</span>       <span class="token comment">//mode是否被终止</span>
    <span class="token keyword">char</span> _padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//几种事件</span>
    CFMutableSetRef _sources0<span class="token punctuation">;</span>  <span class="token comment">//source0</span>
    CFMutableSetRef _sources1<span class="token punctuation">;</span>  <span class="token comment">//source1</span>
    CFMutableArrayRef _observers<span class="token punctuation">;</span> <span class="token comment">// 通知</span>
    CFMutableArrayRef _timers<span class="token punctuation">;</span>    <span class="token comment">// 定时器</span>
    CFMutableDictionaryRef _portToV1SourceMap<span class="token punctuation">;</span>  <span class="token comment">//字典  key是mach_port_t，value是CFRunLoopSourceRef</span>
    __CFPortSet _portSet<span class="token punctuation">;</span>   <span class="token comment">//保存所有需要监听的port，比如_wakeUpPort，_timerPort都保存在这个数组中</span>
    CFIndex _observerMask<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_DISPATCH_SOURCE_FOR_TIMERS</span></span>
    dispatch_source_t _timerSource<span class="token punctuation">;</span>
    dispatch_queue_t _queue<span class="token punctuation">;</span>
    Boolean _timerFired<span class="token punctuation">;</span> <span class="token comment">// set to true by the source when a timer has fired</span>
    Boolean _dispatchTimerArmed<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_MK_TIMER_TOO</span></span>
    mach_port_t _timerPort<span class="token punctuation">;</span>
    Boolean _mkTimerArmed<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
    DWORD _msgQMask<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>_msgPump<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    uint64_t _timerSoftDeadline<span class="token punctuation">;</span> <span class="token comment">/* TSR */</span>
    uint64_t _timerHardDeadline<span class="token punctuation">;</span> <span class="token comment">/* TSR */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>一个CFRunLoopMode对象有一个name，若干source0、source1、timer、observer和若干port，可见事件都是由Mode在管理，而RunLoop管理Mode<br>
从源码很容易看出，Runloop总是运行在某种特定的CFRunLoopModeRef下（每次运行**__CFRunLoopRun()函数时必须指定Mode）。而通过CFRunloopRef对应结构体的定义可以很容易知道每种Runloop都可以包含若干个Mode，每个Mode又包含Source/Timer/Observer。每次调用Runloop的主函数__CFRunLoopRun()时必须指定一种Mode，这个Mode称为 _currentMode**，当切换Mode时必须退出当前Mode，然后重新进入Runloop以保证不同Mode的Source/Timer/Observer互不影响。<br>
RunLoop的运行模式共有5种，RunLoop只会运行在一个模式下，要切换模式，就要暂停当前模式，重写启动一个运行模式</p> <ul><li>NSDefaultRunLoopMode</li> <li>NSConnectionReplyMode</li> <li>NSModalPanelRunLoopMode</li> <li>NSEventTrackingRunLoopMode</li> <li>NSRunLoopCommonModes</li></ul> <table><thead><tr><th>mode</th> <th>name</th> <th>description</th></tr></thead> <tbody><tr><td>Default</td> <td>NSDefaultRunLoopMode(Cocoa) kCFRunLoopDefaultMode(Core Foundation)</td> <td>用的最多的模式，大多数情况下应该使用该模式开始RunLoop并配置input source</td></tr> <tr><td>Connection</td> <td>NSConnectionReplyMode(Cocoa)</td> <td>Cocoa用这个模式结合NSConnection对象检测回应，我们很少使用这种模式</td></tr> <tr><td>Modal</td> <td>NSModalPannelRunLoopMode(Cocoa)</td> <td>Cocoa用此模式来标识用于模态面板的事件</td></tr> <tr><td>Event tracking</td> <td>NSEventTrackingRunLoopMode(Cocoa)</td> <td>Cocoa使用此模式在鼠标拖动loop和其他用户界面跟踪loop期间限制传入事件</td></tr> <tr><td>Common modes</td> <td>NSRunLoopCommonModes(Cocoa) kCFRunLoopCommonModes(Core Foundation)</td> <td>这是一组可配置的常用模式，包括Default、Modal和Event tracking. 可以把自定义的mode加进去</td></tr></tbody></table> <h2 id="runloop-source"><a href="#runloop-source" class="header-anchor">#</a> RunLoop Source</h2> <p>Run Loop Source分为Source、Observer、Timer三种，他们统称为ModeItem</p> <h3 id="cfrunloopsource"><a href="#cfrunloopsource" class="header-anchor">#</a> CFRunLoopSource</h3> <p>根据官方的描述，CFRunLoopSource是对input sources的抽象。CFRunLoopSource分source0和source1两个版本，它的结构如下：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">struct</span> __CFRunLoopSource <span class="token punctuation">{</span>
    CFRuntimeBase _base<span class="token punctuation">;</span>
    uint32_t _bits<span class="token punctuation">;</span>   <span class="token comment">//用于标记Signaled状态，source0只有在被标记为Signaled状态，才会被处理</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>
    CFIndex _order<span class="token punctuation">;</span>			<span class="token comment">/* immutable */</span>
    CFMutableBagRef _runLoops<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
	CFRunLoopSourceContext version0<span class="token punctuation">;</span>	<span class="token comment">/* immutable, except invalidation */</span>
        CFRunLoopSourceContext1 version1<span class="token punctuation">;</span>	<span class="token comment">/* immutable, except invalidation */</span>
    <span class="token punctuation">}</span> _context<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>source0和source1分别是什么</strong></p> <ul><li>source0：是应用自行管理的输入源。应用选择在适当时机调用CFRunLoopSourceSignal来告诉RunLoop有个source0需要处理。譬如，在线程A上完成准备工作后，给线程B的RunLoop中的Source0发送信号，触发（并不是马上）source0回调函数中的主任务逻辑开始执行。CFSocket就是通过source0实现的。</li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    CFIndex	version<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>	info<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>retain<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFStringRef</span>	<span class="token punctuation">(</span><span class="token operator">*</span>copyDescription<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Boolean</span>	<span class="token punctuation">(</span><span class="token operator">*</span>equal<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFHashCode</span>	<span class="token punctuation">(</span><span class="token operator">*</span>hash<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>schedule<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> CFRunLoopRef rl<span class="token punctuation">,</span> CFStringRef mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>cancel<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> CFRunLoopRef rl<span class="token punctuation">,</span> CFStringRef mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>perform<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> CFRunLoopSourceContext<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>source1：是runloop和内核共同管理的输入源。source1需要关联一个mach port，通过mach port发送触发事件信号，从而告诉runloop有个source1需要处理。当mach port收到mach消息时，内核会自动给source1发送信号，match消息的内容也会一并发送给source1，作为触发source1回调函数的上下文参数。CFMatchPort和CFMessagePort就是通过source1实现的。</li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    CFIndex	version<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>	info<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>retain<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFStringRef</span>	<span class="token punctuation">(</span><span class="token operator">*</span>copyDescription<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Boolean</span>	<span class="token punctuation">(</span><span class="token operator">*</span>equal<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFHashCode</span>	<span class="token punctuation">(</span><span class="token operator">*</span>hash<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>TARGET_OS_MAC <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>TARGET_OS_EMBEDDED <span class="token operator">||</span> TARGET_OS_IPHONE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>TARGET_OS_EMBEDDED <span class="token operator">||</span> TARGET_OS_IPHONE<span class="token punctuation">)</span></span></span>
    <span class="token function">mach_port_t</span>	<span class="token punctuation">(</span><span class="token operator">*</span>getPort<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>	<span class="token punctuation">(</span><span class="token operator">*</span>perform<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> CFIndex size<span class="token punctuation">,</span> CFAllocatorRef allocator<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">void</span> <span class="token operator">*</span>	<span class="token punctuation">(</span><span class="token operator">*</span>getPort<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>perform<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span> CFRunLoopSourceContext1<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="cfrunloopobserver"><a href="#cfrunloopobserver" class="header-anchor">#</a> CFRunLoopObserver</h3> <p>CFRunLoopObserver是观察者，可以观察RunLoop的各种状态，并抛出回调。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">struct</span> __CFRunLoopObserver <span class="token punctuation">{</span>
    CFRuntimeBase _base<span class="token punctuation">;</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>
    CFRunLoopRef _runLoop<span class="token punctuation">;</span>
    CFIndex _rlCount<span class="token punctuation">;</span>
    CFOptionFlags _activities<span class="token punctuation">;</span>		<span class="token comment">/* immutable */</span>
    CFIndex _order<span class="token punctuation">;</span>			<span class="token comment">/* immutable */</span>
    CFRunLoopObserverCallBack _callout<span class="token punctuation">;</span>	<span class="token comment">/* immutable */</span>
    CFRunLoopObserverContext _context<span class="token punctuation">;</span>	<span class="token comment">/* immutable, except invalidation */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以观察的状态有如下6个</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/* Run Loop Observer Activities */</span>
<span class="token keyword">typedef</span> <span class="token function">CF_OPTIONS</span><span class="token punctuation">(</span>CFOptionFlags<span class="token punctuation">,</span> CFRunLoopActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kCFRunLoopEntry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">//即将进入run loop</span>
    kCFRunLoopBeforeTimers <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//即将处理timer</span>
    kCFRunLoopBeforeSources <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//即将处理source</span>
    kCFRunLoopBeforeWaiting <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//即将进入休眠</span>
    kCFRunLoopAfterWaiting <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//被唤醒但是还没开始处理事件</span>
    kCFRunLoopExit <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">//run loop已经退出</span>
    kCFRunLoopAllActivities <span class="token operator">=</span> <span class="token number">0x0FFFFFFFU</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Runloop 通过监控 Source 来决定有没有任务要做，除此之外，我们还可以用 Runloop Observer 来监控 Runloop 本身的状态. 具体参考下面的runloop过程</p> <h3 id="cfrunlooptimer"><a href="#cfrunlooptimer" class="header-anchor">#</a> CFRunLoopTimer</h3> <p>CFRunLoopTimer是定时器，可以在设定的时间点抛出回调，它的结构如下：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">struct</span> __CFRunLoopTimer <span class="token punctuation">{</span>
    CFRuntimeBase _base<span class="token punctuation">;</span>
    uint16_t _bits<span class="token punctuation">;</span>  <span class="token comment">//标记fire状态</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>
    CFRunLoopRef _runLoop<span class="token punctuation">;</span>        <span class="token comment">//添加该timer的runloop</span>
    CFMutableSetRef _rlModes<span class="token punctuation">;</span>     <span class="token comment">//存放所有 包含该timer的 mode的 modeName，意味着一个timer可能会在多个mode中存在</span>
    CFAbsoluteTime _nextFireDate<span class="token punctuation">;</span>
    CFTimeInterval _interval<span class="token punctuation">;</span>     <span class="token comment">//理想时间间隔  /* immutable */</span>
    CFTimeInterval _tolerance<span class="token punctuation">;</span>    <span class="token comment">//时间偏差      /* mutable */</span>
    uint64_t _fireTSR<span class="token punctuation">;</span>          <span class="token comment">/* TSR units */</span>
    CFIndex _order<span class="token punctuation">;</span>         <span class="token comment">/* immutable */</span>
    CFRunLoopTimerCallBack _callout<span class="token punctuation">;</span>    <span class="token comment">/* immutable */</span>
    CFRunLoopTimerContext _context<span class="token punctuation">;</span> <span class="token comment">/* immutable, except invalidation */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="runloop运行过程"><a href="#runloop运行过程" class="header-anchor">#</a> RunLoop运行过程</h2> <p><strong>主要步骤</strong></p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token punctuation">{</span>

  <span class="token comment">/// 1. 通知Observers，即将进入RunLoop</span>
  <span class="token comment">/// 此处有Observer会创建AutoreleasePool: _objc_autoreleasePoolPush();    </span>
  <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>kCFRunLoopEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 2. 通知 Observers: 即将触发 Timer 回调。        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>kCFRunLoopBeforeTimers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 3. 通知 Observers: 即将触发 Source (非基于port的,Source0) 回调。        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>kCFRunLoopBeforeSources<span class="token punctuation">)</span>        
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 4. 触发 Source0 (非基于port的) 回调。        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</span><span class="token punctuation">(</span>source0<span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 6. 通知Observers，即将进入休眠</span>
    <span class="token comment">/// 此处有Observer释放并新建AutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>kCFRunLoopBeforeWaiting<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 7. sleep to wait msg.</span>
    <span class="token function">mach_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">mach_msg_trap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 8. 通知Observers，线程被唤醒        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>kCFRunLoopAfterWaiting<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 9. 如果是被Timer唤醒的，回调Timer        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 9. 如果是被dispatch唤醒的，执行所有调用 dispatch_async 等方法放入main queue 的 block        </span>
    <span class="token function">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span><span class="token punctuation">(</span>dispatched_block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 9. 如果如果Runloop是被 Source1 (基于port的) 的事件唤醒了，处理这个事件        </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</span><span class="token punctuation">(</span>source1<span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 10. 通知Observers，即将退出RunLoop    </span>
    <span class="token comment">/// 此处有Observer释放AutoreleasePool: _objc_autoreleasePoolPop();    </span>
    <span class="token function">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span><span class="token punctuation">(</span>kCFRunLoopExit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>在Core Foundation中我们可以通过以下2个API来让RunLoop运行：</p> <ul><li>void CFRunLoopRun(void) 在默认的mode下运行当前线程的RunLoop。</li> <li>CFRunLoopRunResult CFRunLoopRunInMode(CFStringRef mode, CFTimeInterval seconds, Boolean returnAfterSourceHandled)  在指定mode下运行当前线程的RunLoop。</li></ul> <h3 id="cfrunlooprun"><a href="#cfrunlooprun" class="header-anchor">#</a> CFRunLoopRun</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">//默认运行runloop的kCFRunLoopDefaultMode</span>
<span class="token keyword">void</span> <span class="token function">CFRunLoopRun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">/* DOES CALLOUT */</span>
    int32_t result<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">//默认在kCFRunLoopDefaultMode下运行runloop</span>
        result <span class="token operator">=</span> <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kCFRunLoopDefaultMode<span class="token punctuation">,</span> <span class="token number">1.0e10</span><span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>kCFRunLoopRunStopped <span class="token operator">!=</span> result <span class="token operator">&amp;&amp;</span> kCFRunLoopRunFinished <span class="token operator">!=</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在CFRunLoopRun函数中调用了CFRunLoopRunSpecific函数，runloop参数传入当前RunLoop对象，modeName参数传入kCFRunLoopDefaultMode。</p> <h3 id="cfrunloopruninmode"><a href="#cfrunloopruninmode" class="header-anchor">#</a> CFRunLoopRunInMode</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>SInt32 <span class="token function">CFRunLoopRunInMode</span><span class="token punctuation">(</span>CFStringRef modeName<span class="token punctuation">,</span> CFTimeInterval seconds<span class="token punctuation">,</span> Boolean returnAfterSourceHandled<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* DOES CALLOUT */</span>
    <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> modeName<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> returnAfterSourceHandled<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在CFRunLoopRunInMode函数中也调用了CFRunLoopRunSpecific函数，runloop参数传入当前RunLoop对象，modeName参数继续传递CFRunLoopRunInMode传入的modeName。<br>
这里还可以看出，虽然RunLoop有很多个mode，但是RunLoop在run的时候必须只能指定其中一个mode，运行起来之后，被指定的mode即为currentMode</p> <h3 id="cfrunlooprunspecific"><a href="#cfrunlooprunspecific" class="header-anchor">#</a> CFRunLoopRunSpecific</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/*
 * 指定mode运行runloop
 * @param rl 当前运行的runloop
 * @param modeName 需要运行的mode的name
 * @param seconds  runloop的超时时间
 * @param returnAfterSourceHandled 是否处理完事件就返回
 */</span>
SInt32 <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span>CFRunLoopRef rl<span class="token punctuation">,</span> CFStringRef modeName<span class="token punctuation">,</span> CFTimeInterval seconds<span class="token punctuation">,</span> Boolean returnAfterSourceHandled<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* DOES CALLOUT */</span>
    <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopIsDeallocating</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
    <span class="token function">__CFRunLoopLock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据modeName找到本次运行的mode</span>
    CFRunLoopModeRef currentMode <span class="token operator">=</span> <span class="token function">__CFRunLoopFindMode</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> modeName<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果没找到 || mode中没有注册任何事件，则就此停止，不进入循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> currentMode <span class="token operator">||</span> <span class="token function">__CFRunLoopModeIsEmpty</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> rl<span class="token operator">-&gt;</span>_currentMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Boolean did <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token punctuation">)</span> <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>currentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> did <span class="token operator">?</span> kCFRunLoopRunHandledSource <span class="token punctuation">:</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">volatile</span> _per_run_data <span class="token operator">*</span>previousPerRun <span class="token operator">=</span> <span class="token function">__CFRunLoopPushPerRunData</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//取上一次运行的mode</span>
    CFRunLoopModeRef previousMode <span class="token operator">=</span> rl<span class="token operator">-&gt;</span>_currentMode<span class="token punctuation">;</span>
    <span class="token comment">// 设置runloop的当前mode</span>
    rl<span class="token operator">-&gt;</span>_currentMode <span class="token operator">=</span> currentMode<span class="token punctuation">;</span>
    <span class="token comment">//初始化一个result为kCFRunLoopRunFinished</span>
    int32_t result <span class="token operator">=</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
    
    <span class="token comment">// 1.通知observer即将进入runloop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopEntry <span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> kCFRunLoopEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">__CFRunLoopRun</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> returnAfterSourceHandled<span class="token punctuation">,</span> previousMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//10.通知observer已退出runloop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopExit <span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> kCFRunLoopExit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>currentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__CFRunLoopPopPerRunData</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> previousPerRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 还原当前运行的mode</span>
    rl<span class="token operator">-&gt;</span>_currentMode <span class="token operator">=</span> previousMode<span class="token punctuation">;</span>
    <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>通过CFRunLoopRunSpecific的内部逻辑，我们可以得出：</p> <ul><li>如果指定了一个不存在的mode来运行RunLoop，那么会失败，mode不会被创建，所以这里传入的mode必须是存在的</li> <li>如果指定了一个mode，但是这个mode中不包含任何modeItem，那么RunLoop也不会运行，所以必须要* 传入至少包含一个modeItem的mode</li> <li>在进入run loop之前通知observer，状态为kCFRunLoopEntry</li> <li>在退出run loop之后通知observer，状态为kCFRunLoopExit</li></ul> <p>RunLoop的运行的最核心函数是__CFRunLoopRun</p> <h3 id="cfrunlooprun-2"><a href="#cfrunlooprun-2" class="header-anchor">#</a> __CFRunLoopRun</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/*
 * 指定mode运行runloop
 * @param rl 当前运行的runloop
 * @param modeName 需要运行的mode的name
 * @param seconds  runloop的超时时间
 * @param returnAfterSourceHandled 是否处理完事件就返回
 */</span>
SInt32 <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span>CFRunLoopRef rl<span class="token punctuation">,</span> CFStringRef modeName<span class="token punctuation">,</span> CFTimeInterval seconds<span class="token punctuation">,</span> Boolean returnAfterSourceHandled<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* DOES CALLOUT */</span>
    <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopIsDeallocating</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
    <span class="token function">__CFRunLoopLock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据modeName找到本次运行的mode</span>
    CFRunLoopModeRef currentMode <span class="token operator">=</span> <span class="token function">__CFRunLoopFindMode</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> modeName<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果没找到 || mode中没有注册任何事件，则就此停止，不进入循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> currentMode <span class="token operator">||</span> <span class="token function">__CFRunLoopModeIsEmpty</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> rl<span class="token operator">-&gt;</span>_currentMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Boolean did <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token punctuation">)</span> <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>currentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> did <span class="token operator">?</span> kCFRunLoopRunHandledSource <span class="token punctuation">:</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">volatile</span> _per_run_data <span class="token operator">*</span>previousPerRun <span class="token operator">=</span> <span class="token function">__CFRunLoopPushPerRunData</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//取上一次运行的mode</span>
    CFRunLoopModeRef previousMode <span class="token operator">=</span> rl<span class="token operator">-&gt;</span>_currentMode<span class="token punctuation">;</span>
    <span class="token comment">//如果本次mode和上次的mode一致</span>
    rl<span class="token operator">-&gt;</span>_currentMode <span class="token operator">=</span> currentMode<span class="token punctuation">;</span>
    <span class="token comment">//初始化一个result为kCFRunLoopRunFinished</span>
    int32_t result <span class="token operator">=</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
    
    <span class="token comment">// 1.通知observer即将进入runloop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopEntry <span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> kCFRunLoopEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">__CFRunLoopRun</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> returnAfterSourceHandled<span class="token punctuation">,</span> previousMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//10.通知observer已退出runloop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopExit <span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> kCFRunLoopExit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>currentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__CFRunLoopPopPerRunData</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> previousPerRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rl<span class="token operator">-&gt;</span>_currentMode <span class="token operator">=</span> previousMode<span class="token punctuation">;</span>
    <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
复制代码通过CFRunLoopRunSpecific的内部逻辑，我们可以得出：

如果指定了一个不存在的mode来运行RunLoop，那么会失败，mode不会被创建，所以这里传入的mode必须是存在的
如果指定了一个mode，但是这个mode中不包含任何modeItem，那么RunLoop也不会运行，所以必须要<span class="token operator">*</span> 传入至少包含一个modeItem的mode
在进入run loop之前通知observer，状态为kCFRunLoopEntry
在退出run loop之后通知observer，状态为kCFRunLoopExit

RunLoop的运行的最核心函数是__CFRunLoopRun，接下来我们分析__CFRunLoopRun的源码。
__CFRunLoopRun
这段代码比较长<span class="token punctuation">,</span>请做好心理准备，我已经加了比较详细的注释。本节开头的run loop运行步骤<span class="token number">2</span><span class="token operator">~</span><span class="token number">9</span>步都在下面的代码中得到验证。
<span class="token comment">/**
 *  运行run loop
 *
 *  @param rl              运行的RunLoop对象
 *  @param rlm             运行的mode
 *  @param seconds         run loop超时时间
 *  @param stopAfterHandle true:run loop处理完事件就退出  false:一直运行直到超时或者被手动终止
 *  @param previousMode    上一次运行的mode
 *
 *  @return 返回4种状态
 */</span>
<span class="token keyword">static</span> int32_t <span class="token function">__CFRunLoopRun</span><span class="token punctuation">(</span>CFRunLoopRef rl<span class="token punctuation">,</span> CFRunLoopModeRef rlm<span class="token punctuation">,</span> CFTimeInterval seconds<span class="token punctuation">,</span> Boolean stopAfterHandle<span class="token punctuation">,</span> CFRunLoopModeRef previousMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取系统启动后的CPU运行时间，用于控制超时时间</span>
    uint64_t startTSR <span class="token operator">=</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//如果RunLoop或者mode是stop状态，则直接return，不进入循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopIsStopped</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__CFRunLoopUnsetStopped</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> kCFRunLoopRunStopped<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rlm<span class="token operator">-&gt;</span>_stopped <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token keyword">return</span> kCFRunLoopRunStopped<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//mach端口，在内核中，消息在端口之间传递。 初始为0</span>
    mach_port_name_t dispatchPort <span class="token operator">=</span> MACH_PORT_NULL<span class="token punctuation">;</span>
    <span class="token comment">//判断是否为主线程</span>
    Boolean libdispatchQSafe <span class="token operator">=</span> <span class="token function">pthread_main_np</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY <span class="token operator">&amp;&amp;</span> <span class="token constant">NULL</span> <span class="token operator">==</span> previousMode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">==</span> <span class="token function">_CFGetTSD</span><span class="token punctuation">(</span>__CFTSDKeyIsInGCDMainQ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果在主线程 &amp;&amp; runloop是主线程的runloop &amp;&amp; 该mode是commonMode，则给mach端口赋值为主线程收发消息的端口</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>libdispatchQSafe <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">CFRunLoopGetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> rl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">CFSetContainsValue</span><span class="token punctuation">(</span>rl<span class="token operator">-&gt;</span>_commonModes<span class="token punctuation">,</span> rlm<span class="token operator">-&gt;</span>_name<span class="token punctuation">)</span><span class="token punctuation">)</span> dispatchPort <span class="token operator">=</span> <span class="token function">_dispatch_get_main_queue_port_4CF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_DISPATCH_SOURCE_FOR_TIMERS</span></span>
    mach_port_name_t modeQueuePort <span class="token operator">=</span> MACH_PORT_NULL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//mode赋值为dispatch端口_dispatch_runloop_root_queue_perform_4CF</span>
        modeQueuePort <span class="token operator">=</span> <span class="token function">_dispatch_runloop_root_queue_get_port_4CF</span><span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modeQueuePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CRASH</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to get port for run loop mode queue (%d)&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token comment">//GCD管理的定时器，用于实现runloop超时机制</span>
    dispatch_source_t timeout_timer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> __timeout_context <span class="token operator">*</span>timeout_context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> __timeout_context <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>timeout_context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//立即超时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">&lt;=</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// instant timeout</span>
        seconds <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        timeout_context<span class="token operator">-&gt;</span>termTSR <span class="token operator">=</span> <span class="token number">0ULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//seconds为超时时间，超时时执行__CFRunLoopTimeout函数</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">&lt;=</span> TIMER_INTERVAL_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_HIGH<span class="token punctuation">,</span> DISPATCH_QUEUE_OVERCOMMIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timeout_timer <span class="token operator">=</span> <span class="token function">dispatch_source_create</span><span class="token punctuation">(</span>DISPATCH_SOURCE_TYPE_TIMER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_retain</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timeout_context<span class="token operator">-&gt;</span>ds <span class="token operator">=</span> timeout_timer<span class="token punctuation">;</span>
        timeout_context<span class="token operator">-&gt;</span>rl <span class="token operator">=</span> <span class="token punctuation">(</span>CFRunLoopRef<span class="token punctuation">)</span><span class="token function">CFRetain</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timeout_context<span class="token operator">-&gt;</span>termTSR <span class="token operator">=</span> startTSR <span class="token operator">+</span> <span class="token function">__CFTimeIntervalToTSR</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_set_context</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">,</span> timeout_context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// source gets ownership of context</span>
        <span class="token function">dispatch_source_set_event_handler_f</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">,</span> __CFRunLoopTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_source_set_cancel_handler_f</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">,</span> __CFRunLoopTimeoutCancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint64_t ns_at <span class="token operator">=</span> <span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__CFTSRToTimeInterval</span><span class="token punctuation">(</span>startTSR<span class="token punctuation">)</span> <span class="token operator">+</span> seconds<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000000000ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_source_set_timer</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">,</span> <span class="token function">dispatch_time</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ns_at<span class="token punctuation">)</span><span class="token punctuation">,</span> DISPATCH_TIME_FOREVER<span class="token punctuation">,</span> <span class="token number">1000ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_resume</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//永不超时</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// infinite timeout</span>
        seconds <span class="token operator">=</span> <span class="token number">9999999999.0</span><span class="token punctuation">;</span>
        timeout_context<span class="token operator">-&gt;</span>termTSR <span class="token operator">=</span> UINT64_MAX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//标志位默认为true</span>
    Boolean didDispatchPortLastTime <span class="token operator">=</span> true<span class="token punctuation">;</span>
    <span class="token comment">//记录最后runloop状态，用于return</span>
    int32_t retVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">//初始化一个存放内核消息的缓冲池</span>
        uint8_t msg_buffer<span class="token punctuation">[</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_MACOSX <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span>
        mach_msg_header_t <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        mach_port_t livePort <span class="token operator">=</span> MACH_PORT_NULL<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
        HANDLE livePort <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        Boolean windowsMessageReceived <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token comment">//取所有需要监听的port</span>
        __CFPortSet waitSet <span class="token operator">=</span> rlm<span class="token operator">-&gt;</span>_portSet<span class="token punctuation">;</span>
        
        <span class="token comment">//设置RunLoop为可以被唤醒状态</span>
        <span class="token function">__CFRunLoopUnsetIgnoreWakeUps</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.通知observer，即将触发timer回调，处理timer事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopBeforeTimers<span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> kCFRunLoopBeforeTimers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.通知observer，即将触发Source0回调</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopBeforeSources<span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> kCFRunLoopBeforeSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//执行加入当前runloop的block</span>
        <span class="token function">__CFRunLoopDoBlocks</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//4.处理source0事件</span>
        <span class="token comment">//有事件处理返回true，没有事件返回false</span>
        Boolean sourceHandledThisLoop <span class="token operator">=</span> <span class="token function">__CFRunLoopDoSources0</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> stopAfterHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceHandledThisLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//执行加入当前runloop的block</span>
            <span class="token function">__CFRunLoopDoBlocks</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//如果没有Sources0事件处理 并且 没有超时，poll为false</span>
        <span class="token comment">//如果有Sources0事件处理 或者 超时，poll都为true</span>
        Boolean poll <span class="token operator">=</span> sourceHandledThisLoop <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0ULL</span> <span class="token operator">==</span> timeout_context<span class="token operator">-&gt;</span>termTSR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//第一次do..whil循环不会走该分支，因为didDispatchPortLastTime初始化是true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MACH_PORT_NULL <span class="token operator">!=</span> dispatchPort <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didDispatchPortLastTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_MACOSX <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span>
            <span class="token comment">//从缓冲区读取消息</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span>mach_msg_header_t <span class="token operator">*</span><span class="token punctuation">)</span>msg_buffer<span class="token punctuation">;</span>
            <span class="token comment">//5.接收dispatchPort端口的消息，（接收source1事件）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopServiceMachPort</span><span class="token punctuation">(</span>dispatchPort<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果接收到了消息的话，前往第9步开始处理msg</span>
                <span class="token keyword">goto</span> handle_msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopWaitForMultipleObjects</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dispatchPort<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> handle_msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
        
        didDispatchPortLastTime <span class="token operator">=</span> false<span class="token punctuation">;</span>
        
        <span class="token comment">//6.通知观察者RunLoop即将进入休眠</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poll <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopBeforeWaiting<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> kCFRunLoopBeforeWaiting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置RunLoop为休眠状态</span>
        <span class="token function">__CFRunLoopSetSleeping</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// do not do any user callouts after this point (after notifying of sleeping)</span>
        
        <span class="token comment">// Must push the local-to-this-activation ports in on every loop</span>
        <span class="token comment">// iteration, as this mode could be run re-entrantly and we don't</span>
        <span class="token comment">// want these ports to get serviced.</span>
        
        <span class="token function">__CFPortSetInsert</span><span class="token punctuation">(</span>dispatchPort<span class="token punctuation">,</span> waitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_MACOSX <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_DISPATCH_SOURCE_FOR_TIMERS</span></span>
        <span class="token comment">//这里有个内循环，用于接收等待端口的消息</span>
        <span class="token comment">//进入此循环后，线程进入休眠，直到收到新消息才跳出该循环，继续执行run loop</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>kCFUseCollectableAllocator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">objc_clear_stack</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memset</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span>mach_msg_header_t <span class="token operator">*</span><span class="token punctuation">)</span>msg_buffer<span class="token punctuation">;</span>
            <span class="token comment">//7.接收waitSet端口的消息</span>
            <span class="token function">__CFRunLoopServiceMachPort</span><span class="token punctuation">(</span>waitSet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> poll <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> TIMEOUT_INFINITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//收到消息之后，livePort的值为msg-&gt;msgh_local_port，</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>modeQueuePort <span class="token operator">!=</span> MACH_PORT_NULL <span class="token operator">&amp;&amp;</span> livePort <span class="token operator">==</span> modeQueuePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">_dispatch_runloop_root_queue_perform_4CF</span><span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_timerFired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Leave livePort as the queue port, and service timers below</span>
                    rlm<span class="token operator">-&gt;</span>_timerFired <span class="token operator">=</span> false<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">&amp;&amp;</span> msg <span class="token operator">!=</span> <span class="token punctuation">(</span>mach_msg_header_t <span class="token operator">*</span><span class="token punctuation">)</span>msg_buffer<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Go ahead and leave the inner loop.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kCFUseCollectableAllocator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">objc_clear_stack</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        msg <span class="token operator">=</span> <span class="token punctuation">(</span>mach_msg_header_t <span class="token operator">*</span><span class="token punctuation">)</span>msg_buffer<span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopServiceMachPort</span><span class="token punctuation">(</span>waitSet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> poll <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> TIMEOUT_INFINITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        
        
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
        <span class="token comment">// Here, use the app-supplied message queue mask. They will set this if they are interested in having this run loop receive windows messages.</span>
        <span class="token function">__CFRunLoopWaitForMultipleObjects</span><span class="token punctuation">(</span>waitSet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> poll <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> TIMEOUT_INFINITY<span class="token punctuation">,</span> rlm<span class="token operator">-&gt;</span>_msgQMask<span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> <span class="token operator">&amp;</span>windowsMessageReceived<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        
        <span class="token function">__CFRunLoopLock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopModeLock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Must remove the local-to-this-activation ports in on every loop</span>
        <span class="token comment">// iteration, as this mode could be run re-entrantly and we don't</span>
        <span class="token comment">// want these ports to get serviced. Also, we don't want them left</span>
        <span class="token comment">// in there if this function returns.</span>
        
        <span class="token function">__CFPortSetRemove</span><span class="token punctuation">(</span>dispatchPort<span class="token punctuation">,</span> waitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
 
        <span class="token function">__CFRunLoopSetIgnoreWakeUps</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// user callouts now OK again</span>
        <span class="token comment">//取消runloop的休眠状态</span>
        <span class="token function">__CFRunLoopUnsetSleeping</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//8.通知观察者runloop被唤醒</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poll <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_observerMask <span class="token operator">&amp;</span> kCFRunLoopAfterWaiting<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> kCFRunLoopAfterWaiting<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
        <span class="token comment">//9.处理收到的消息</span>
    handle_msg<span class="token punctuation">:</span><span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopSetIgnoreWakeUps</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowsMessageReceived<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// These Win32 APIs cause a callout, so make sure we're unlocked first and relocked after</span>
            <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_msgPump<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rlm<span class="token operator">-&gt;</span><span class="token function">_msgPump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                MSG msg<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PeekMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PM_REMOVE <span class="token operator">|</span> PM_NOYIELD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">DispatchMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            <span class="token function">__CFRunLoopLock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopModeLock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sourceHandledThisLoop <span class="token operator">=</span> true<span class="token punctuation">;</span>
            
            <span class="token comment">// To prevent starvation of sources other than the message queue, we check again to see if any other sources need to be serviced</span>
            <span class="token comment">// Use 0 for the mask so windows messages are ignored this time. Also use 0 for the timeout, because we're just checking to see if the things are signalled right now -- we will wait on them again later.</span>
            <span class="token comment">// NOTE: Ignore the dispatch source (it's not in the wait set anymore) and also don't run the observers here since we are polling.</span>
            <span class="token function">__CFRunLoopSetSleeping</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token function">__CFRunLoopWaitForMultipleObjects</span><span class="token punctuation">(</span>waitSet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token function">__CFRunLoopLock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopModeLock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopUnsetSleeping</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If we have a new live port then it will be handled below as normal</span>
        <span class="token punctuation">}</span>
        
        
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MACH_PORT_NULL <span class="token operator">==</span> livePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CFRUNLOOP_WAKEUP_FOR_NOTHING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// handle nothing</span>
            <span class="token comment">//通过CFRunloopWake唤醒</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>livePort <span class="token operator">==</span> rl<span class="token operator">-&gt;</span>_wakeUpPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CFRUNLOOP_WAKEUP_FOR_WAKEUP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//什么都不干，跳回2重新循环</span>
            <span class="token comment">// do nothing on Mac OS</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
            <span class="token comment">// Always reset the wake up port, or risk spinning forever</span>
            <span class="token function">ResetEvent</span><span class="token punctuation">(</span>rl<span class="token operator">-&gt;</span>_wakeUpPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_DISPATCH_SOURCE_FOR_TIMERS</span></span>
        <span class="token comment">//如果是定时器事件</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>modeQueuePort <span class="token operator">!=</span> MACH_PORT_NULL <span class="token operator">&amp;&amp;</span> livePort <span class="token operator">==</span> modeQueuePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CFRUNLOOP_WAKEUP_FOR_TIMER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//9.1 处理timer事件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__CFRunLoopDoTimers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Re-arm the next timer, because we apparently fired early</span>
                <span class="token function">__CFArmNextTimerInMode</span><span class="token punctuation">(</span>rlm<span class="token punctuation">,</span> rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_MK_TIMER_TOO</span></span>
        <span class="token comment">//如果是定时器事件</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_timerPort <span class="token operator">!=</span> MACH_PORT_NULL <span class="token operator">&amp;&amp;</span> livePort <span class="token operator">==</span> rlm<span class="token operator">-&gt;</span>_timerPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CFRUNLOOP_WAKEUP_FOR_TIMER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// On Windows, we have observed an issue where the timer port is set before the time which we requested it to be set. For example, we set the fire time to be TSR 167646765860, but it is actually observed firing at TSR 167646764145, which is 1715 ticks early. The result is that, when __CFRunLoopDoTimers checks to see if any of the run loop timers should be firing, it appears to be 'too early' for the next timer, and no timers are handled.</span>
            <span class="token comment">// In this case, the timer port has been automatically reset (since it was returned from MsgWaitForMultipleObjectsEx), and if we do not re-arm it, then no timers will ever be serviced again unless something adjusts the timer list (e.g. adding or removing timers). The fix for the issue is to reset the timer here if CFRunLoopDoTimers did not handle a timer itself. 9308754</span>
           <span class="token comment">//9.1处理timer事件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__CFRunLoopDoTimers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Re-arm the next timer</span>
                <span class="token function">__CFArmNextTimerInMode</span><span class="token punctuation">(</span>rlm<span class="token punctuation">,</span> rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token comment">//如果是dispatch到main queue的block</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>livePort <span class="token operator">==</span> dispatchPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CFRUNLOOP_WAKEUP_FOR_DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopModeUnlock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopUnlock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_CFSetTSD</span><span class="token punctuation">(</span>__CFTSDKeyIsInGCDMainQ<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
            <span class="token keyword">void</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token comment">//9.2执行block</span>
            <span class="token function">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_CFSetTSD</span><span class="token punctuation">(</span>__CFTSDKeyIsInGCDMainQ<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopLock</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__CFRunLoopModeLock</span><span class="token punctuation">(</span>rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sourceHandledThisLoop <span class="token operator">=</span> true<span class="token punctuation">;</span>
            didDispatchPortLastTime <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">CFRUNLOOP_WAKEUP_FOR_SOURCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Despite the name, this works for windows handles as well</span>
            CFRunLoopSourceRef rls <span class="token operator">=</span> <span class="token function">__CFRunLoopModeFindSourceForMachPort</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> livePort<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 有source1事件待处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_MACOSX <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span>
                mach_msg_header_t <span class="token operator">*</span>reply <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token comment">//9.2 处理source1事件</span>
                sourceHandledThisLoop <span class="token operator">=</span> <span class="token function">__CFRunLoopDoSource1</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> rls<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>msgh_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span> <span class="token operator">||</span> sourceHandledThisLoop<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mach_msg</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> MACH_SEND_MSG<span class="token punctuation">,</span> reply<span class="token operator">-&gt;</span>msgh_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MACH_PORT_NULL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MACH_PORT_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">CFAllocatorDeallocate</span><span class="token punctuation">(</span>kCFAllocatorSystemDefault<span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">DEPLOYMENT_TARGET_WINDOWS</span></span>
                sourceHandledThisLoop <span class="token operator">=</span> <span class="token function">__CFRunLoopDoSource1</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> rls<span class="token punctuation">)</span> <span class="token operator">||</span> sourceHandledThisLoop<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEPLOYMENT_TARGET_MACOSX <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED <span class="token operator">||</span> DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">&amp;&amp;</span> msg <span class="token operator">!=</span> <span class="token punctuation">(</span>mach_msg_header_t <span class="token operator">*</span><span class="token punctuation">)</span>msg_buffer<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        
        <span class="token function">__CFRunLoopDoBlocks</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceHandledThisLoop <span class="token operator">&amp;&amp;</span> stopAfterHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//进入run loop时传入的参数，处理完事件就返回</span>
            retVal <span class="token operator">=</span> kCFRunLoopRunHandledSource<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_context<span class="token operator">-&gt;</span>termTSR <span class="token operator">&lt;</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//run loop超时</span>
            retVal <span class="token operator">=</span> kCFRunLoopRunTimedOut<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopIsStopped</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//run loop被手动终止</span>
            <span class="token function">__CFRunLoopUnsetStopped</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> kCFRunLoopRunStopped<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-&gt;</span>_stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//mode被终止</span>
            rlm<span class="token operator">-&gt;</span>_stopped <span class="token operator">=</span> false<span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> kCFRunLoopRunStopped<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopModeIsEmpty</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> previousMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//mode中没有要处理的事件</span>
            retVal <span class="token operator">=</span> kCFRunLoopRunFinished<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//除了上面这几种情况，都继续循环</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> retVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch_source_cancel</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_release</span><span class="token punctuation">(</span>timeout_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">free</span><span class="token punctuation">(</span>timeout_context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br></div></div><h3 id="cfrunloopservicemachport"><a href="#cfrunloopservicemachport" class="header-anchor">#</a> __CFRunLoopServiceMachPort</h3> <p>第7步调用了__CFRunLoopServiceMachPort函数</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 *  接收指定内核端口的消息
 *
 *  @param port        接收消息的端口
 *  @param buffer      消息缓冲区
 *  @param buffer_size 消息缓冲区大小
 *  @param livePort    暂且理解为活动的端口，接收消息成功时候值为msg-&gt;msgh_local_port，超时时为MACH_PORT_NULL
 *  @param timeout     超时时间，单位是ms，如果超时，则RunLoop进入休眠状态
 *
 *  @return 接收消息成功时返回true 其他情况返回false
 */</span>
<span class="token keyword">static</span> Boolean <span class="token function">__CFRunLoopServiceMachPort</span><span class="token punctuation">(</span>mach_port_name_t port<span class="token punctuation">,</span> mach_msg_header_t <span class="token operator">*</span><span class="token operator">*</span>buffer<span class="token punctuation">,</span> size_t buffer_size<span class="token punctuation">,</span> mach_port_t <span class="token operator">*</span>livePort<span class="token punctuation">,</span> mach_msg_timeout_t timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Boolean originalBuffer <span class="token operator">=</span> true<span class="token punctuation">;</span>
    kern_return_t ret <span class="token operator">=</span> KERN_SUCCESS<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">/* In that sleep of death what nightmares may come ... */</span>
        mach_msg_header_t <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token punctuation">(</span>mach_msg_header_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>buffer<span class="token punctuation">;</span>
        msg<span class="token operator">-&gt;</span>msgh_bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//消息头的标志位</span>
        msg<span class="token operator">-&gt;</span>msgh_local_port <span class="token operator">=</span> port<span class="token punctuation">;</span>  <span class="token comment">//源(发出的消息)或者目标(接收的消息)</span>
        msg<span class="token operator">-&gt;</span>msgh_remote_port <span class="token operator">=</span> MACH_PORT_NULL<span class="token punctuation">;</span> <span class="token comment">//目标(发出的消息)或者源(接收的消息)</span>
        msg<span class="token operator">-&gt;</span>msgh_size <span class="token operator">=</span> buffer_size<span class="token punctuation">;</span>  <span class="token comment">//消息缓冲区大小，单位是字节</span>
        msg<span class="token operator">-&gt;</span>msgh_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//唯一id</span>
       
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TIMEOUT_INFINITY <span class="token operator">==</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CFRUNLOOP_SLEEP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token function">CFRUNLOOP_POLL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        
        <span class="token comment">//通过mach_msg发送或者接收的消息都是指针，</span>
        <span class="token comment">//如果直接发送或者接收消息体，会频繁进行内存复制，损耗性能</span>
        <span class="token comment">//所以XNU使用了单一内核的方式来解决该问题，所有内核组件都共享同一个地址空间，因此传递消息时候只需要传递消息的指针</span>
        ret <span class="token operator">=</span> <span class="token function">mach_msg</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>
                       MACH_RCV_MSG<span class="token operator">|</span>MACH_RCV_LARGE<span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TIMEOUT_INFINITY <span class="token operator">!=</span> timeout<span class="token punctuation">)</span> <span class="token operator">?</span> MACH_RCV_TIMEOUT <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token function">MACH_RCV_TRAILER_TYPE</span><span class="token punctuation">(</span>MACH_MSG_TRAILER_FORMAT_0<span class="token punctuation">)</span><span class="token operator">|</span><span class="token function">MACH_RCV_TRAILER_ELEMENTS</span><span class="token punctuation">(</span>MACH_RCV_TRAILER_AV<span class="token punctuation">)</span><span class="token punctuation">,</span>
                       <span class="token number">0</span><span class="token punctuation">,</span>
                       msg<span class="token operator">-&gt;</span>msgh_size<span class="token punctuation">,</span>
                       port<span class="token punctuation">,</span>
                       timeout<span class="token punctuation">,</span>
                       MACH_PORT_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CFRUNLOOP_WAKEUP</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//接收/发送消息成功，给livePort赋值为msgh_local_port</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MACH_MSG_SUCCESS <span class="token operator">==</span> ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>livePort <span class="token operator">=</span> msg <span class="token operator">?</span> msg<span class="token operator">-&gt;</span>msgh_local_port <span class="token punctuation">:</span> MACH_PORT_NULL<span class="token punctuation">;</span>
            <span class="token keyword">return</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//MACH_RCV_TIMEOUT</span>
        <span class="token comment">//超出timeout时间没有收到消息，返回MACH_RCV_TIMED_OUT</span>
        <span class="token comment">//此时释放缓冲区，把livePort赋值为MACH_PORT_NULL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MACH_RCV_TIMED_OUT <span class="token operator">==</span> ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>originalBuffer<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>livePort <span class="token operator">=</span> MACH_PORT_NULL<span class="token punctuation">;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//MACH_RCV_LARGE</span>
        <span class="token comment">//如果接收缓冲区太小，则将过大的消息放在队列中，并且出错返回MACH_RCV_TOO_LARGE，</span>
        <span class="token comment">//这种情况下，只返回消息头，调用者可以分配更多的内存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MACH_RCV_TOO_LARGE <span class="token operator">!=</span> ret<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">//此处给buffer分配更大内存</span>
        buffer_size <span class="token operator">=</span> <span class="token function">round_msg</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>msgh_size <span class="token operator">+</span> MAX_TRAILER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>originalBuffer<span class="token punctuation">)</span> <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        originalBuffer <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token punctuation">,</span> buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    HALT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>RunLoop实际很简单，它是一个对象，它和线程是一一对应的，每个线程都有一个对应的RunLoop对象，主线程的RunLoop会在程序启动时自动创建，子线程需要手动获取来创建。<br>
RunLoop运行的核心是一个do..while..循环，遍历所有需要处理的事件，如果有事件处理就让线程工作，没有事件处理则让线程休眠，同时等待事件到来。</p> <h2 id="相关问题"><a href="#相关问题" class="header-anchor">#</a> 相关问题</h2> <h3 id="autoreleasepool-在何时被释放"><a href="#autoreleasepool-在何时被释放" class="header-anchor">#</a> autoreleasePool 在何时被释放？</h3> <p>App启动后，苹果在主线程 RunLoop 里注册了两个 Observer，其回调都是 _wrapRunLoopWithAutoreleasePoolHandler()。<br>
第一个 Observer 监视的事件是 Entry(即将进入Loop)，其回调内会调用 _objc_autoreleasePoolPush() 创建自动释放池。其 order 是 -2147483647，优先级最高，保证创建释放池发生在其他所有回调之前。<br>
第二个 Observer 监视了两个事件： BeforeWaiting(准备进入休眠) 时调用_objc_autoreleasePoolPop() 和 _objc_autoreleasePoolPush() 释放旧的池并创建新池；Exit(即将退出Loop) 时调用 _objc_autoreleasePoolPop() 来释放自动释放池。这个 Observer 的 order 是 2147483647，优先级最低，保证其释放池子发生在其他所有回调之后。<br>
在主线程执行的代码，通常是写在诸如事件回调、Timer回调内的。这些回调会被 RunLoop 创建好的 AutoreleasePool 环绕着，所以不会出现内存泄漏，开发者也不必显示创建 Pool 了。</p> <h3 id="gcd-在runloop中的使用"><a href="#gcd-在runloop中的使用" class="header-anchor">#</a> GCD 在Runloop中的使用？</h3> <p>GCD由子线程返回到主线程,只有在这种情况下才会触发 RunLoop。会触发 RunLoop 的 Source1 事件。</p> <h3 id="performselector-的实现原理"><a href="#performselector-的实现原理" class="header-anchor">#</a> PerformSelector 的实现原理</h3> <ul><li>当调用 NSObject 的 performSelecter:afterDelay: 后，实际上其内部会创建一个 Timer 并添加到当前线程的 RunLoop 中。所以如果当前线程没有 RunLoop，则这个方法会失效。</li> <li>当调用 performSelector:onThread: 时，实际上其会创建一个 Timer 加到对应的线程去，同样的，如果对应线程没有 RunLoop 该方法也会失效。</li></ul> <h3 id="performselector-afterdelay-这个方法在子线程中是否起作用"><a href="#performselector-afterdelay-这个方法在子线程中是否起作用" class="header-anchor">#</a> PerformSelector:afterDelay:这个方法在子线程中是否起作用？</h3> <p>不起作用，子线程默认没有 Runloop，也就没有 Timer。可以使用 GCD的dispatch_after来实现</p> <h3 id="事件响应的过程"><a href="#事件响应的过程" class="header-anchor">#</a> 事件响应的过程？</h3> <ul><li>苹果注册了一个 Source1 (基于 mach port 的) 用来接收系统事件，其回调函数为 __IOHIDEventSystemClientQueueCallback()。</li> <li>当一个硬件事件(触摸/锁屏/摇晃等)发生后，首先由 IOKit.framework 生成一个 IOHIDEvent 事件并由 SpringBoard 接收。SpringBoard 只接收按键(锁屏/静音等)，触摸，加速，接近传感器等几种 Event，随后用 mach port 转发给需要的 App 进程。随后苹果注册的那个 Source1 就会触发回调，并调用 _UIApplicationHandleEventQueue() 进行应用内部的分发。</li> <li>_UIApplicationHandleEventQueue() 会把 IOHIDEvent 处理并包装成 UIEvent 进行处理或分发，其中包括识别 UIGesture/处理屏幕旋转/发送给 UIWindow 等。通常事件比如 UIButton 点击、touchesBegin/Move/End/Cancel 事件都是在这个回调中完成的。</li></ul> <h3 id="手势识别过程"><a href="#手势识别过程" class="header-anchor">#</a> 手势识别过程</h3> <ul><li>当 _UIApplicationHandleEventQueue() 识别了一个手势时，其首先会调用 Cancel 将当前的 touchesBegin/Move/End 系列回调打断。随后系统将对应的 UIGestureRecognizer 标记为待处理。</li> <li>苹果注册了一个 Observer 监测 BeforeWaiting (Loop即将进入休眠) 事件，这个 Observer 的回调函数是 _UIGestureRecognizerUpdateObserver()，其内部会获取所有刚被标记为待处理的 GestureRecognizer，并执行GestureRecognizer 的回调。</li> <li>当有 UIGestureRecognizer 的变化(创建/销毁/状态改变)时，这个回调都会进行相应处理。</li></ul> <h3 id="cadispalytimer和timer哪个更精确"><a href="#cadispalytimer和timer哪个更精确" class="header-anchor">#</a> CADispalyTimer和Timer哪个更精确</h3> <p>CADisplayLink 更精确</p> <ul><li>iOS设备的屏幕刷新频率是固定的，CADisplayLink在正常情况下会在每次刷新结束都被调用，精确度相当高。</li> <li>NSTimer的精确度就显得低了点，比如NSTimer的触发时间到的时候，runloop如果在阻塞状态，触发时间就会推迟到下一个runloop周期。并且 NSTimer新增了tolerance属性，让用户可以设置可以容忍的触发的时间的延迟范围。</li> <li>CADisplayLink使用场合相对专一，适合做UI的不停重绘，比如自定义动画引擎或者视频播放的渲染。</li> <li>NSTimer的使用范围要广泛的多，各种需要单次或者循环定时处理的任务都可以使用。在UI相关的动画或者显示内容使用</li> <li>CADisplayLink比起用NSTimer的好处就是我们不需要在格外关心屏幕的刷新频率了，因为它本身就是跟屏幕刷新同步的。</li></ul> <h3 id="滚动scrollview导致定时器失效"><a href="#滚动scrollview导致定时器失效" class="header-anchor">#</a> 滚动Scrollview导致定时器失效</h3> <p>在界面上有一个UIScrollview控件，如果此时还有一个定时器在执行一个事件，你会发现当你滚动Scrollview的时候，定时器会失效.<br>
因为当你滚动Scrollview的时候，RunLoop会切换到UITrackingRunLoopMode 模式，而定时器运行在defaultMode下面，系统一次只能处理一种模式的RunLoop，所以导致defaultMode下的定时器失效<br>
解决方法：</p> <ul><li>把timer注册到NSRunLoopCommonModes，它包含了defaultMode和trackingMode两种模式。</li> <li>使用GCD创建定时器，GCD创建的定时器不会受RunLoop的影响</li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 获得队列</span>
dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个定时器(dispatch_source_t本质还是个OC对象)</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">dispatch_source_create</span><span class="token punctuation">(</span>DISPATCH_SOURCE_TYPE_TIMER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置定时器的各种属性（几时开始任务，每隔多长时间执行一次）</span>
<span class="token comment">// GCD的时间参数，一般是纳秒（1秒 == 10的9次方纳秒）</span>
<span class="token comment">// 比当前时间晚1秒开始执行</span>
dispatch_time_t start <span class="token operator">=</span> <span class="token function">dispatch_time</span><span class="token punctuation">(</span>DISPATCH_TIME_NOW<span class="token punctuation">,</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">*</span> NSEC_PER_SEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//每隔一秒执行一次</span>
uint64_t interval <span class="token operator">=</span> <span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">*</span> NSEC_PER_SEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispatch_source_set_timer</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>timer<span class="token punctuation">,</span> start<span class="token punctuation">,</span> interval<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置回调</span>
<span class="token function">dispatch_source_set_event_handler</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>timer<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;------------%@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动定时器</span>
<span class="token function">dispatch_resume</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="图片下载"><a href="#图片下载" class="header-anchor">#</a> 图片下载</h3> <p>由于图片渲染到屏幕需要消耗较多资源，为了提高用户体验，当用户滚动Tableview的时候，只在后台下载图片，但是不显示图片，当用户停下来的时候才显示图片</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>imageView performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>setImage<span class="token punctuation">:</span><span class="token punctuation">)</span> withObject<span class="token punctuation">:</span><span class="token punctuation">[</span>UIImage imageNamed<span class="token punctuation">:</span><span class="token string">@&quot;imgName&quot;</span><span class="token punctuation">]</span> afterDelay<span class="token punctuation">:</span><span class="token number">3.0</span> inModes<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span>NSDefaultRunLoopMode<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面的代码可以达到如下效果：
用户点击屏幕，在主线程中，三秒之后显示图片，但是当用户点击屏幕之后，如果此时用户又开始滚动textview，那么就算过了三秒，图片也不会显示出来，当用户停止了滚动，才会显示图片。
这是因为限定了方法setImage只能在NSDefaultRunLoopMode 模式下使用。而滚动textview的时候，程序运行在tracking模式下面，所以方法setImage不会执行。</p> <h3 id="常驻线程"><a href="#常驻线程" class="header-anchor">#</a> 常驻线程</h3> <p>需要创建一个在后台一直存在的程序，来做一些需要频繁处理的任务。比如检测网络状态等。<br>
默认情况一个线程创建出来，运行完要做的事情，线程就会消亡。而程序启动的时候，就创建的主线程已经加入到RunLoop，所以主线程不会消亡。<br>
这个时候我们就需要把自己创建的线程加到RunLoop中来，就可以实现线程常驻后台。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">self</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span> initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>run <span class="token punctuation">{</span>
  <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;----------run----%@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">@</span>autoreleasepool<span class="token punctuation">{</span>
  <span class="token comment">/*如果不加这句，会发现runloop创建出来就挂了，因为runloop如果没有CFRunLoopSourceRef事件源输入或者定时器，就会立马消亡。
    下面的方法给runloop添加一个NSport，就是添加一个事件源，也可以添加一个定时器，或者observer，让runloop不会挂掉*/</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span> addPort<span class="token punctuation">:</span><span class="token punctuation">[</span>NSPort port<span class="token punctuation">]</span> forMode<span class="token punctuation">:</span>NSDefaultRunLoopMode<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 方法1 ,2，3实现的效果相同，让runloop无限期运行下去</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span> run<span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

  
  <span class="token comment">// 方法2</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span> runMode<span class="token punctuation">:</span>NSDefaultRunLoopMode beforeDate<span class="token punctuation">:</span><span class="token punctuation">[</span>NSDate distantFuture<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 方法3</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span> runUntilDate<span class="token punctuation">:</span><span class="token punctuation">[</span>NSDate distantFuture<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test <span class="token punctuation">{</span>
  <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;----------test----%@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span>NSSet <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span>UIEvent <span class="token operator">*</span><span class="token punctuation">)</span>event <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token keyword">self</span> performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> onThread<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>thread withObject<span class="token punctuation">:</span>nil waitUntilDone<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">self</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span> initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>run<span class="token punctuation">{</span>
  <span class="token punctuation">[</span>NSTimer scheduledTimerWithTimeInterval<span class="token punctuation">:</span><span class="token number">2.0</span> target<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> userInfo<span class="token punctuation">:</span>nil repeats<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span> run<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果没有实现添加NSPort或者NSTimer，会发现执行完run方法，线程就会消亡，后续再执行touchbegan方法无效。<br>
我们必须保证线程不消亡，才可以在后台接受时间处理<br>
RunLoop 启动前内部必须要有至少一个 Timer/Observer/Source，所以在 [runLoop run] 之前先创建了一个新的 NSMachPort 添加进去了。通常情况下，调用者需要持有这个 NSMachPort (mach_port) 并在外部线程通过这个 port 发送消息到 RunLoop 内；但此处添加 port 只是为了让 RunLoop 不至于退出，并没有用于实际的发送消息。<br>
可以发现执行完了run方法，这个时候再点击屏幕，可以不断执行test方法，因为线程self.thread一直常驻后台，等待事件加入其中，然后执行。</p> <h3 id="卡顿监控"><a href="#卡顿监控" class="header-anchor">#</a> 卡顿监控</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">@interface</span> <span class="token function">PerformanceMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> timeoutCount<span class="token punctuation">;</span>
  CFRunLoopObserverRef observer<span class="token punctuation">;</span>
  
  <span class="token keyword">@public</span>
  dispatch_semaphore_t semaphore<span class="token punctuation">;</span>
  CFRunLoopActivity activity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@implementation</span> PerformanceMonitor

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runLoopObserverCallBack</span><span class="token punctuation">(</span>CFRunLoopObserverRef observer<span class="token punctuation">,</span> CFRunLoopActivity activity<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  PerformanceMonitor <span class="token operator">*</span>moniotor <span class="token operator">=</span> <span class="token punctuation">(</span>__bridge PerformanceMonitor<span class="token operator">*</span><span class="token punctuation">)</span>info<span class="token punctuation">;</span>
  moniotor<span class="token operator">-&gt;</span>activity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
  dispatch_semaphore_t semaphore <span class="token operator">=</span> moniotor<span class="token operator">-&gt;</span>semaphore<span class="token punctuation">;</span>
  <span class="token function">dispatch_semaphore_signal</span><span class="token punctuation">(</span>semaphore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>startMonitor <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//信号，dispatch semaphore保证同步</span>
  semaphore <span class="token operator">=</span> <span class="token function">dispatch_semaphore_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//注册RunLoop状态观察</span>
  CFRunLoopObserverContext context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__bridge <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  observer <span class="token operator">=</span> <span class="token function">CFRunLoopObserverCreate</span><span class="token punctuation">(</span>kCFAllocatorDefault<span class="token punctuation">,</span>
                                     kCFRunLoopAllActivities<span class="token punctuation">,</span>
                                     YES<span class="token punctuation">,</span>
                                     <span class="token number">0</span><span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>runLoopObserverCallBack<span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//将观察者添加到主线程runloop的common模式下的观察中</span>
  <span class="token function">CFRunLoopAddObserver</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> observer<span class="token punctuation">,</span> kCFRunLoopCommonModes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//在子线程监控， 开启一个持续的loop用来进行监控</span>
  <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>YES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//假定连续5次超过50ms认为卡顿（当然也包含了单次超过250ms）</span>
      <span class="token keyword">long</span> st <span class="token operator">=</span> <span class="token function">dispatch_semaphore_wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token operator">-&gt;</span>semaphore<span class="token punctuation">,</span> <span class="token function">dispatch_time</span><span class="token punctuation">(</span>DISPATCH_TIME_NOW<span class="token punctuation">,</span> <span class="token number">50</span><span class="token operator">*</span>NSEC_PER_MSEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>st <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">self</span><span class="token operator">-&gt;</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">self</span><span class="token operator">-&gt;</span>timeoutCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">self</span><span class="token operator">-&gt;</span>semaphore <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">self</span><span class="token operator">-&gt;</span>activity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//两个runloop的状态，kCFRunLoopBeforeSources和kCFRunLoopAfterWaiting这两个状态区间时间能检测到是否卡顿</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token operator">-&gt;</span>activity <span class="token operator">==</span> kCFRunLoopBeforeSources <span class="token operator">||</span> <span class="token keyword">self</span><span class="token operator">-&gt;</span>activity <span class="token operator">==</span> kCFRunLoopAfterWaiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">self</span><span class="token operator">-&gt;</span>timeoutCount <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;发生卡顿&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//采集其他数据，并进行数据上报</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">self</span><span class="token operator">-&gt;</span>timeoutCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>stopMonitor <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">CFRunLoopRemoveObserver</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> observer<span class="token punctuation">,</span> kCFRunLoopCommonModes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CFRelease</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  observer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/30/2022, 3:36:56 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/ios/basic/runtime.html" class="prev">
            Runtime
          </a></span> <span class="next"><a href="/ios/basic/multithread/process-thread.html">
            进程和线程
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#runloop是什么" class="sidebar-link reco-side-runloop是什么" data-v-70334359>RunLoop是什么</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#runloop作用" class="sidebar-link reco-side-runloop作用" data-v-70334359>Runloop作用</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#runloop和线程的关系" class="sidebar-link reco-side-runloop和线程的关系" data-v-70334359>RunLoop和线程的关系</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#runloop-mode" class="sidebar-link reco-side-runloop-mode" data-v-70334359>RunLoop Mode</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#runloop-source" class="sidebar-link reco-side-runloop-source" data-v-70334359>RunLoop Source</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunloopsource" class="sidebar-link reco-side-cfrunloopsource" data-v-70334359>CFRunLoopSource</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunloopobserver" class="sidebar-link reco-side-cfrunloopobserver" data-v-70334359>CFRunLoopObserver</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunlooptimer" class="sidebar-link reco-side-cfrunlooptimer" data-v-70334359>CFRunLoopTimer</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#runloop运行过程" class="sidebar-link reco-side-runloop运行过程" data-v-70334359>RunLoop运行过程</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunlooprun" class="sidebar-link reco-side-cfrunlooprun" data-v-70334359>CFRunLoopRun</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunloopruninmode" class="sidebar-link reco-side-cfrunloopruninmode" data-v-70334359>CFRunLoopRunInMode</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunlooprunspecific" class="sidebar-link reco-side-cfrunlooprunspecific" data-v-70334359>CFRunLoopRunSpecific</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunlooprun-2" class="sidebar-link reco-side-cfrunlooprun-2" data-v-70334359>__CFRunLoopRun</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cfrunloopservicemachport" class="sidebar-link reco-side-cfrunloopservicemachport" data-v-70334359>__CFRunLoopServiceMachPort</a></li><li class="level-2" data-v-70334359><a href="/ios/basic/runloop.html#相关问题" class="sidebar-link reco-side-相关问题" data-v-70334359>相关问题</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#autoreleasepool-在何时被释放" class="sidebar-link reco-side-autoreleasepool-在何时被释放" data-v-70334359>autoreleasePool 在何时被释放？</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#gcd-在runloop中的使用" class="sidebar-link reco-side-gcd-在runloop中的使用" data-v-70334359>GCD 在Runloop中的使用？</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#performselector-的实现原理" class="sidebar-link reco-side-performselector-的实现原理" data-v-70334359>PerformSelector 的实现原理</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#performselector-afterdelay-这个方法在子线程中是否起作用" class="sidebar-link reco-side-performselector-afterdelay-这个方法在子线程中是否起作用" data-v-70334359>PerformSelector:afterDelay:这个方法在子线程中是否起作用？</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#事件响应的过程" class="sidebar-link reco-side-事件响应的过程" data-v-70334359>事件响应的过程？</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#手势识别过程" class="sidebar-link reco-side-手势识别过程" data-v-70334359>手势识别过程</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#cadispalytimer和timer哪个更精确" class="sidebar-link reco-side-cadispalytimer和timer哪个更精确" data-v-70334359>CADispalyTimer和Timer哪个更精确</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#滚动scrollview导致定时器失效" class="sidebar-link reco-side-滚动scrollview导致定时器失效" data-v-70334359>滚动Scrollview导致定时器失效</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#图片下载" class="sidebar-link reco-side-图片下载" data-v-70334359>图片下载</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#常驻线程" class="sidebar-link reco-side-常驻线程" data-v-70334359>常驻线程</a></li><li class="level-3" data-v-70334359><a href="/ios/basic/runloop.html#卡顿监控" class="sidebar-link reco-side-卡顿监控" data-v-70334359>卡顿监控</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.e1d9a5d5.js" defer></script><script src="/assets/js/4.c013567b.js" defer></script><script src="/assets/js/1.9dc3b061.js" defer></script><script src="/assets/js/100.7e99e635.js" defer></script><script src="/assets/js/14.ec05e296.js" defer></script>
  </body>
</html>
